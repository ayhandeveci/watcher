<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bayes Rezerv Oyunu</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444}
  body{margin:0;background:#0f172a;color:var(--ink);font-family:Inter,system-ui}
  header{padding:12px;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:10px}
  h1{font-size:18px;margin:0;flex:1}
  .infoBtn{padding:6px 10px;border-radius:8px;border:1px solid #334155;background:#0b1023;color:#fff;cursor:pointer}
  .wrap{max-width:1280px;margin:auto;padding:14px;display:grid;gap:14px}
  .cols-4{display:grid;grid-template-columns:1.1fr 1fr 1fr 0.9fr;gap:14px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:10px;padding:12px}
  h2{margin:0 0 8px;font-size:15px}
  select,.btn{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1023;color:#fff}
  .btn{cursor:pointer;margin-top:6px}
  .btn.primary{background:var(--accent);color:#000;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px 8px;text-align:left}
  th{position:sticky;top:0;background:#0e162a}
  .face{font-size:40px}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#111827;padding:16px;border-radius:12px;width:90%;max-width:680px}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choices .btn{flex:1}
  .spinner{width:28px;height:28px;border:3px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header>
  <h1>🕹️ Bayes Rezerv Oyunu</h1>
  <button id="flowBtn" class="infoBtn">ℹ️ Akış</button>
</header>

<div class="wrap">
  <section class="cols-4">
    <!-- Panel 1 -->
    <div class="card">
      <h2>1) Yıl Başı — Portföy</h2>
      <label>Fiyatlama</label>
      <select id="price">
        <option value="cheap">Ucuz</option>
        <option value="mid" selected>Orta</option>
        <option value="exp">Pahalı</option>
      </select>
      <label>Underwriting</label>
      <select id="uw">
        <option value="loose">Gevşek</option>
        <option value="mid" selected>Orta</option>
        <option value="strict">Sıkı</option>
      </select>
      <label>Satış Kanalı</label>
      <select id="channel">
        <option value="agent">Acente</option>
        <option value="balanced" selected>Dengeli</option>
        <option value="digital">Dijital</option>
      </select>
      <label>PR / Reklam</label>
      <select id="ads">
        <option value="low">Düşük</option>
        <option value="mid" selected>Orta</option>
        <option value="high">Yüksek</option>
      </select>

      <button class="btn primary" id="startYear">Yılı Başlat</button>
      <button class="btn" id="drawEvent" disabled>🎲 Olayı Çek</button>
      <button class="btn" id="resetGame">Sıfırla</button>

      <div id="eventBadge" class="mono" style="margin-top:6px">Olay: —</div>
      <div id="midInfo" class="mono"></div>
    </div>

    <!-- Panel 2 -->
    <div class="card">
      <h2>2) Yıl Ortası — Rezerv</h2>
      <button class="btn" id="reserveBtn" disabled>ULR nasıl gelişir?</button>
      <div id="midPanel" class="mono" style="margin-top:8px"></div>
    </div>

    <!-- Panel 3 -->
    <div class="card">
      <h2>3) Yıl Sonu — Temettü</h2>
      <button class="btn" id="divBtn" disabled>Temettü Seçimi</button>
      <div id="endPanel" class="mono" style="margin-top:8px"></div>
    </div>

    <!-- Panel 4 -->
    <div class="card">
      <h2>4) CEO / Sermayedar</h2>
      <div id="ceoFace" class="face">🙂</div>
      <div id="ceoStats" class="mono"></div>
      <div id="statusBox" class="mono" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Alt tablo -->
  <section class="card">
    <h2>Yıl Sonuçları</h2>
    <table id="yearsTbl">
      <thead>
        <tr>
          <th>Yıl</th><th>Olay</th><th>GWP</th><th>incLR</th><th>realLR</th><th>LR*</th>
          <th>Ödenen</th><th>Muallak</th><th>Rezerv</th><th>Kom.</th><th>PR</th>
          <th>VÖ</th><th>Vergi</th><th>VS</th><th>Temettü</th><th>Sermaye</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
/* ---------- helpers ---------- */
const $=id=>document.getElementById(id);
const showModal=html=>{ $("modalBox").innerHTML=html; $("modal").style.display="flex"; };
const closeModal=()=>{ $("modal").style.display="none"; };
const fmt=(x,d=2)=>Number(x).toFixed(d);

function rngNormal(mu,sigma){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+sigma*z;}
function rngTNormal(mu,sigma,a,b){for(let i=0;i<2000;i++){const x=rngNormal(mu,sigma);if(x>=a&&x<=b)return x;}return Math.max(a,Math.min(b,mu));}

/* ---------- config ---------- */
const CONFIG={
  capital0:100, tax:0.20, baseGwp:90, lrBounds:[0.35,1.4], earnedShare:0.5,
  // GWP çarpanları
  fPrice:v=>v==="cheap"?1.30:v==="exp"?0.85:1.10,
  fUW:v=>v==="loose"?1.10:v==="strict"?0.90:1.00,
  fChannel:v=>v==="agent"?1.10:v==="digital"?0.95:1.00,
  fAds:l=>{const m={low:0,mid:1,high:2}[l]; return 1+0.08*m-0.02*m*m;},
  // Masraf oranları
  commPct:ch=>ch==="agent"?0.18:ch==="digital"?0.05:0.12,
  adsPct:l=>l==="low"?0.01:l==="high"?0.06:0.03
};

/* ---------- state ---------- */
const state={
  year:1, capital:CONFIG.capital0, cumDiv:0, warned:false,
  cache:null, currentRow:null, fired:false, bankrupt:false
};

/* ---------- events ---------- */
const EVENTS=[
 {key:"normal",name:"Normal",mu:0.65,sigma:0.05,paidShare:0.60,volMul:1.00,blurb:"Her şey normal."},
 {key:"pricewar",name:"Fiyat Savaşı",mu:0.74,sigma:0.06,paidShare:0.52,volMul:1.08,blurb:"Agresif fiyat rekabeti."},
 {key:"cat",name:"CAT",mu:0.80,sigma:0.08,paidShare:0.70,volMul:1.00,blurb:"Felaket yılı, büyük hasar."},
 {key:"pr",name:"PR Krizi",mu:0.66,sigma:0.06,paidShare:0.58,volMul:0.95,blurb:"İmaj kaybı, masraflar artar."}
];

/* ---------- portfolio risk score ---------- */
function portfolioRiskScore(price,uw,channel,ads){
  let s=0;
  if(price==="cheap")s+=0.6; else if(price==="exp")s-=0.4;
  if(uw==="loose")s+=0.8; else if(uw==="strict")s-=0.6;
  if(channel==="agent")s+=0.2; else if(channel==="digital")s-=0.1;
  if(ads==="high")s+=0.1; else if(ads==="low")s-=0.05;
  return Math.max(-1,Math.min(1,s/1.5));
}

/* ---------- table utils ---------- */
function ensureRowForYear(y){
  const tb = document.querySelector("#yearsTbl tbody");
  let tr = tb.querySelector(`tr[data-year="${y}"]`);
  if(!tr){
    tr = document.createElement("tr");
    tr.dataset.year = y;
    tr.innerHTML = "<td>"+y+"</td>"+("<td>—</td>".repeat(15));
    tb.prepend(tr);
  }
  state.currentRow = tr;
  return tr;
}
function setCell(idx, html){
  if(!state.currentRow) return;
  const tds = state.currentRow.children;
  if(tds[idx]) tds[idx].innerHTML = html;
}

/* ---------- CEO panel ---------- */
function updateCEO(){
  const ratio=state.capital>0 ? state.cumDiv/state.capital : 0;
  $("ceoStats").innerText=`Sermaye=${fmt(state.capital)} | Kümülatif Temettü=${fmt(state.cumDiv)} | Oran=%${fmt(ratio*100)}`;
  if(state.capital<50){$("ceoFace").innerText="💀";$("statusBox").innerText="İflas!"; state.bankrupt=true; return;}
  if(ratio<0.1 && state.year>2){$("ceoFace").innerText="😡";$("statusBox").innerText="CEO görevden alındı!"; state.fired=true; return;}
  $("ceoFace").innerText= ratio>=0.2?"😃":"🙂";
  $("statusBox").innerText="Oyuna devam...";
}
updateCEO();

/* ---------- flow popup ---------- */
$("flowBtn").onclick=()=>showModal(`
  <h3>Oyun Akışı</h3>
  <ol class="mono">
    <li>Yıl başında portföy parametrelerini seç.</li>
    <li>“Olayı Çek” → 5 sn. zar animasyonu → yılın olayı, incLR ve yıl ortası ödemeler görünür.</li>
    <li>“ULR nasıl gelişir?” → <b>incLR’nin %20 altı</b> / <b>incLR</b> / <b>incLR’nin %20 fazlası</b> arasından hedef seç; rezerv ayrılır.</li>
    <li>Seçimin ardından <b>realLR</b> rastgele (riskine eğimli) çekilir; <b>VÖ</b> ve <b>VS</b> tabloda hemen görünür.</li>
    <li>Temettü seç (%0/%50/%75/%100). 5 yıl tamamlarsan oyunu <b>kazanırsın</b>. Sermaye &lt; 50 ise iflas; 2 yıldan sonra oran &lt; %10 ise CEO görevden alınır.</li>
  </ol>
  <div class="choices"><button class="btn" onclick="closeModal()">Tamam</button></div>
`);

/* ---------- buttons ---------- */
$("resetGame").onclick=()=>{ location.reload(); };

$("startYear").onclick=()=>{
  if(state.bankrupt || state.fired) return;
  $("drawEvent").disabled=false;
  $("reserveBtn").disabled=true;
  $("divBtn").disabled=true;
  $("eventBadge").textContent="Olay: —";
  $("midInfo").textContent="";
  $("midPanel").textContent="";
  $("endPanel").textContent="";
  state.cache=null;
  ensureRowForYear(state.year);
  for(let i=1;i<=15;i++) setCell(i,"—");
};

$("drawEvent").onclick=()=>{
  if(state.bankrupt || state.fired) return;
  showModal(`<div><span class="spinner"></span> 🎲 Zar atılıyor...</div>`);
  setTimeout(()=>{
    closeModal();

    const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
    $("eventBadge").innerText=`Olay: ${ev.name} — ${ev.blurb}`;

    const price=$("price").value, uw=$("uw").value, ch=$("channel").value, ads=$("ads").value;
    const GWP = CONFIG.baseGwp
      * CONFIG.fPrice(price) * CONFIG.fUW(uw) * CONFIG.fChannel(ch) * CONFIG.fAds(ads) * ev.volMul;

    const incLR=rngTNormal(ev.mu,ev.sigma,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);
    const earned=GWP*CONFIG.earnedShare;
    const incurred=earned*incLR;
    const paid=incurred*ev.paidShare;
    const outst=incurred-paid;

    const comm=GWP*CONFIG.commPct(ch);
    const pr=GWP*CONFIG.adsPct(ads);

    state.cache={ev,GWP,incLR,paid,outst,comm,pr,mu_post:ev.mu,sigma_post:ev.sigma, price,uw,ch,ads};

    $("midInfo").innerText=`incLR=%${fmt(incLR*100)} | Ödenen=${fmt(paid)} | Muallak=${fmt(outst)}`;
    $("reserveBtn").disabled=false;

    ensureRowForYear(state.year);
    setCell(1, ev.name);
    setCell(2, fmt(GWP));
    setCell(3, "%"+fmt(incLR*100));
    setCell(6, fmt(paid));
    setCell(7, fmt(outst));
    setCell(9, fmt(comm));
    setCell(10, fmt(pr));
  }, 5000);
};

$("reserveBtn").onclick=()=>{
  const k=state.cache; if(!k) return;
  // Şıklar: inc*0.8, inc*1.0, inc*1.2  (bounds içinde kırp)
  const a = Math.max(CONFIG.lrBounds[0], Math.min(CONFIG.lrBounds[1], k.incLR*0.8));
  const b = Math.max(CONFIG.lrBounds[0], Math.min(CONFIG.lrBounds[1], k.incLR));
  const c = Math.max(CONFIG.lrBounds[0], Math.min(CONFIG.lrBounds[1], k.incLR*1.2));
  showModal(`
    <h3>ULR nasıl gelişir?</h3>
    <div class="choices">
      <button class="btn" onclick="chooseReserve(${a})">%${fmt(a*100)} (incLR - %20)</button>
      <button class="btn" onclick="chooseReserve(${b})">%${fmt(b*100)} (incLR)</button>
      <button class="btn" onclick="chooseReserve(${c})">%${fmt(c*100)} (incLR + %20)</button>
    </div>
  `);
};

window.chooseReserve=(lrStar)=>{
  closeModal();
  const k=state.cache; if(!k) return;

  // Rezerv tutarı (LR* üzerinden)
  const need=k.GWP*lrStar-(k.paid+k.outst);
  k.lrStar=lrStar;
  k.resv=Math.max(0,need);

  // ====== REAL LR ŞİMDİ ÇEKİLİR (rezervden HEMEN SONRA GÖRÜNSÜN) ======
  const rScore=portfolioRiskScore(k.price,k.uw,k.ch,k.ads);
  const muAdj  = k.mu_post + 0.10 * rScore;
  const sigAdj = k.sigma_post * (1 + 1.0*Math.abs(rScore));
  k.realLR = rngTNormal(muAdj,sigAdj,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);

  // P&L öğeleri (VÖ/VS temettüden ÖNCE tabloda)
  const realNeed   = k.GWP*k.realLR-(k.paid+k.outst);
  const pnlResv    = realNeed - k.resv;
  const VO         = k.GWP-(k.paid+k.outst+k.resv)-k.comm-k.pr+pnlResv;
  const tax        = VO>0 ? VO*CONFIG.tax : 0;
  const VS         = VO - tax;
  k.VO = VO; k.tax = tax; k.VS = VS; // temettü adımında aynen kullanacağız

  $("divBtn").disabled=false;
  $("midPanel").innerText=`Seçilen ULR hedefi=%${fmt(lrStar*100)}, Rezerv=${fmt(k.resv)}\nrealLR=%${fmt(k.realLR*100)} | VÖ=${fmt(VO)} | VS=${fmt(VS)}`;

  // tabloyu güncelle
  ensureRowForYear(state.year);
  setCell(5, "%"+fmt(lrStar*100));     // LR*
  setCell(8, fmt(k.resv));             // Rezerv
  setCell(4, "%"+fmt(k.realLR*100));   // realLR (hemen görünsün)
  setCell(11, (VO>=0?'<span class="ok">':'<span class="bad">')+fmt(VO)+'</span>'); // VÖ
  setCell(12, fmt(tax));               // Vergi
  setCell(13, (VS>=0?'<span class="ok">':'<span class="bad">')+fmt(VS)+'</span>');  // VS
};

$("divBtn").onclick=()=>{
  const k=state.cache; if(!k) return;
  if(state.bankrupt || state.fired) return;

  // Temettü modalı (VO/VS zaten hesaplandı ve tabloda)
  showModal(`
    <h3>Temettü Seç</h3>
    <div class="choices">
      <button class="btn" onclick="payDiv(0)">%0</button>
      <button class="btn" onclick="payDiv(0.5)">%50</button>
      <button class="btn" onclick="payDiv(0.75)">%75</button>
      <button class="btn" onclick="payDiv(1)">%100</button>
    </div>
  `);

  window.payDiv=(f)=>{
    closeModal();
    const div = k.VS>0 ? k.VS*f : 0;
    state.cumDiv += div;
    state.capital += k.VS - div;

    setCell(14, fmt(div));
    setCell(15, fmt(state.capital));

    updateCEO();

    $("drawEvent").disabled=true;
    $("reserveBtn").disabled=true;
    $("divBtn").disabled=true;

    // 5 YIL TAMAMLAMA = KAZANÇ
    if(!state.bankrupt && !state.fired && state.year>=5){
      const ratio = state.capital>0 ? state.cumDiv/state.capital : 0;
      showModal(`<h3>🎉 5 yılı tamamladın — Oyunu Kazandın!</h3>
        <div class="mono">Sermaye: ${fmt(state.capital)} | Kümülatif Temettü: ${fmt(state.cumDiv)} | Oran: %${fmt(ratio*100)}</div>
        <div class="choices"><button class="btn" onclick="closeModal()">Tamam</button></div>`);
    }

    state.year++;
  };
};
</script>
</body>
</html>
