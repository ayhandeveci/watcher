<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Watcher – Yıllık Sigorta Simülatörü (GitHub Pages)</title>
<style>
  :root{
    --bg:#0f1222; --card:#171a2c; --muted:#9aa3b2; --fg:#eef2ff; --accent:#7aa2ff; --ok:#50d38a; --warn:#ffd066; --bad:#ff7a7a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0c1020,#0f1222 60%);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:20px 16px;border-bottom:1px solid #22263e;position:sticky;top:0;background:#0f1222d0;backdrop-filter: blur(6px)}
  h1{margin:0;font-size:20px;letter-spacing:.3px}
  main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns: 1.1fr 1.5fr}
  .card{background:var(--card);border:1px solid #232845;border-radius:12px;padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
  select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3050;background:#0f1326;color:var(--fg);font-size:14px}
  button{cursor:pointer;background:linear-gradient(180deg,#24305a,#1b264d);border-color:#2a376a}
  button.primary{background:linear-gradient(180deg,#3b5bdc,#2845a8);border-color:#2d47a8}
  button.ghost{background:transparent;border-color:#344;opacity:.9}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .kpi{background:#0f1326;border:1px solid #232845;border-radius:10px;padding:10px}
  .kpi b{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .kpi span{font-size:18px}
  .kpi.ok span{color:var(--ok)} .kpi.warn span{color:var(--warn)} .kpi.bad span{color:var(--bad)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #232845;padding:8px 6px;text-align:right}
  th{color:#a9b3c7;font-weight:600}
  td:first-child, th:first-child{text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2b3050;font-size:11px;color:#cbd5ff}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .footer{color:var(--muted);font-size:12px;margin-top:8px}
  .sep{height:1px;background:#232845;margin:10px 0}
  .muted{color:var(--muted)}
  .danger{color:var(--bad);font-weight:600}
  .success{color:var(--ok);font-weight:600}
</style>
</head>
<body>
<header>
  <h1>Watcher – Yıllık Sigorta Simülatörü</h1>
</header>
<main>
  <section class="card">
    <h2 style="margin:0 0 6px 0;font-size:16px">Yıl Başı Stratejisi</h2>
    <div class="row">
      <div>
        <label>Fiyatlama</label>
        <select id="pricing">
          <option value="cheap">Ucuz (hacim↑, risk↑)</option>
          <option value="mid" selected>Orta (dengeli)</option>
          <option value="expensive">Pahalı (hacim↓, risk↓)</option>
        </select>
      </div>
      <div>
        <label>Underwriting (Risk Kabul)</label>
        <select id="uw">
          <option value="loose">Gevşek (riskli karışım)</option>
          <option value="mid" selected>Orta</option>
          <option value="tight">Sıkı (daha temiz portföy)</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>Satış Kanalı</label>
        <select id="channel">
          <option value="agent">Acente (komisyon yüksek)</option>
          <option value="balanced" selected>Dengeli</option>
          <option value="digital">Dijital (komisyon düşük)</option>
        </select>
      </div>
      <div>
        <label>Reklam & İmaj</label>
        <select id="ads">
          <option value="low">Düşük</option>
          <option value="mid" selected>Orta</option>
          <option value="high">Yüksek</option>
        </select>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid2">
      <div>
        <label>Regülasyon (Zorluk)</label>
        <select id="regime">
          <option value="easy">Easy – <50 iflas</option>
          <option value="medium" selected>Medium – <75 iki yıl üst üste iflas</option>
          <option value="hard">Hard – <100 iflas</option>
        </select>
      </div>
      <div>
        <label>Vergi Oranı</label>
        <select id="tax">
          <option value="0.10">%10</option>
          <option value="0.20" selected>%20</option>
          <option value="0.30">%30</option>
        </select>
      </div>
    </div>

    <div class="sep"></div>
    <div class="flex">
      <button id="btnRoll" class="primary">1) Olayları Çek (Yıl İçi)</button>
      <span class="hint">Olay çekildikten sonra yıl sonu rezerv politikasını seçeceksin.</span>
    </div>

    <div id="eventBox" style="display:none;margin-top:10px">
      <div class="pill" id="eventPill">Olay: —</div>
      <div class="metrics">
        <div class="kpi"><b>GWP (Prim)</b><span id="mGwp">—</span></div>
        <div class="kpi"><b>LR (Hasar Oranı)</b><span id="mLR">—</span></div>
        <div class="kpi"><b>Komisyon</b><span id="mComm">—</span></div>
      </div>
      <div class="metrics">
        <div class="kpi"><b>Reklam</b><span id="mAds">—</span></div>
        <div class="kpi"><b>Tahsil (ödenen)</b><span id="mPaid">—</span></div>
        <div class="kpi"><b>Rezerv Bazı</b><span id="mResBase">—</span></div>
      </div>

      <div class="sep"></div>
      <div class="row">
        <div>
          <label>Yıl Sonu Rezerv Politikası</label>
          <select id="reservePolicy">
            <option value="conservative">Konservatif (yüksek rezerv)</option>
            <option value="neutral" selected>Nötr</option>
            <option value="aggressive">Agresif (düşük rezerv)</option>
          </select>
          <div class="hint">Rezerv kararı kapanış öncesi verilir.</div>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button id="btnClose" class="primary">2) Yılı Kapat (Rezerv + Vergi + Sermaye)</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px 0;font-size:16px">Durum & Rapor</h2>
    <div class="grid2">
      <div class="kpi"><b>Yıl</b><span id="kYear">1</span></div>
      <div class="kpi"><b>Sermaye</b><span id="kCapital">100.00</span></div>
    </div>
    <div class="metrics">
      <div class="kpi" id="kpiStatus"><b>Durum</b><span id="kStatus">Başlangıç</span></div>
      <div class="kpi"><b>İflas Eşiği</b><span id="kThresh">Medium: <75 iki yıl</span></div>
      <div class="kpi"><b>İmaj</b><span id="kBrand">Orta</span></div>
    </div>
    <div class="sep"></div>
    <div class="flex">
      <button id="btnNext" class="ghost" disabled>Yeni Yıla Geç</button>
      <button id="btnReset" class="">Sıfırla</button>
      <span class="hint">Yıl kapanmadan yeni yıla geçemezsin.</span>
    </div>
    <div class="sep"></div>
    <div class="footer">Her yıl: Strateji → Olay → <b>Rezerv Seç</b> → Vergi & Sermaye → İflas kontrol → Yeni yıl.</div>
  </section>

  <section class="card" style="grid-column:1 / -1">
    <h2 style="margin:0 0 6px 0;font-size:16px">Yıl Bazlı Kayıt</h2>
    <table id="log">
      <thead>
        <tr>
          <th>Yıl</th><th>Olay</th><th>Fiyat</th><th>UW</th><th>Kanal</th><th>Reklam</th>
          <th>Rezerv</th><th>GWP</th><th>LR</th><th>Ödenen</th><th>Rezerv</th><th>Kom.</th><th>Reklam</th><th>VÖ</th><th>Vergi</th><th>VS</th><th>Sermaye</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
/* =========================
   CONFIG – katsayılar
   ========================= */
const CONFIG = {
  baseGWP: 100,         // baz prim (denge & normal)
  baseLR: 0.65,         // baz hasar oranı (LR)
  tax: 0.20,            // default; UI'dan güncellenir
  paidRatio: 0.70,      // yıl içinde ödenen hasar oranı
  // Olay olasılıkları (toplam 1.0)
  events: [
    {name:"Normal", p:0.60, lrAdd:0.00, volMul:1.00, brand:"="},
    {name:"Fiyat Savaşı", p:0.20, lrAdd:0.05, volMul:1.10, brand:"-"},
    {name:"Cat", p:0.15, lrAdd:0.12, volMul:1.00, brand:"="},
    {name:"PR Krizi", p:0.05, lrAdd:0.01, volMul:0.90, brand:"--"}
  ],
  // Strateji etkileri
  pricing: {
    cheap:      {volMul:1.00, lrAdd:0.08}, // ucuz → risk↑
    mid:        {volMul:1.00, lrAdd:0.00},
    expensive:  {volMul:0.85, lrAdd:-0.06}
  },
  uw: {
    loose:{lrAdd:0.04}, mid:{lrAdd:0.00}, tight:{lrAdd:-0.03}
  },
  channel: {
    agent:{comm:0.18, brand:"+", demand:1.00},
    balanced:{comm:0.12, brand:"=", demand:1.00},
    digital:{comm:0.05, brand:"-", demand:0.95}
  },
  ads: {
    low:{rate:0.01, brand:-1, demand:0.95},
    mid:{rate:0.03, brand:0, demand:1.00},
    high:{rate:0.06, brand:+1, demand:1.10}
  },
  reservePolicy:{
    conservative:{mult:1.20, label:"Konservatif"},
    neutral:{mult:1.00, label:"Nötr"},
    aggressive:{mult:0.80, label:"Agresif"}
  },
  regimes:{
    easy:{label:"Easy: <50 iflas", test:(cap, trail)=> cap<50 ? "FAIL" : "OK"},
    medium:{label:"Medium: <75 iki yıl", test:(cap, trail)=> {
      // trail: önceki yılda <75 miydi?
      if(cap < 75){
        return (trail ? "FAIL" : "WARN"); // üst üste iki yıl <75 → FAIL
      }
      return "OK";
    }},
    hard:{label:"Hard: <100 iflas", test:(cap, trail)=> cap<100 ? "FAIL" : "OK"}
  }
};

// Global durum
let state = {
  year: 1,
  capital: 100.00,
  brandScore: 0,           // imaj (negatif / pozitif)
  lowTrailPrev: false,     // Medium rejimde <75 geçmiş yıl bayrağı
  regime: "medium",
  taxRate: CONFIG.tax,
  locked: false,           // olay çekildi mi?
  current: null            // geçici yıl verileri (kapanış öncesi)
};

// Kısayol
const $ = sel => document.querySelector(sel);
const logBody = $("#log tbody");

// UI init
function refreshUI(){
  $("#kYear").textContent = state.year;
  $("#kCapital").textContent = state.capital.toFixed(2);
  $("#kBrand").textContent = state.brandScore>0 ? "Yüksek"
                      : state.brandScore<0 ? "Düşük" : "Orta";
  const reg = CONFIG.regimes[state.regime];
  $("#kThresh").textContent = reg.label;
  $("#kStatus").textContent = state.locked ? "Yıl içi olay çekildi" : "Strateji bekleniyor";
  $("#kpiStatus").className = "kpi " + (state.locked ? "warn":"");
  $("#eventBox").style.display = state.locked ? "block" : "none";
  $("#btnNext").disabled = !!state.locked; // kapanmadan geçiş yok
}
refreshUI();

$("#regime").addEventListener("change", e=>{
  state.regime = e.target.value;
  refreshUI();
});
$("#tax").addEventListener("change", e=>{
  state.taxRate = parseFloat(e.target.value);
});

// Olay çek
$("#btnRoll").addEventListener("click", ()=>{
  if(state.locked){return;}
  // Stratejileri oku
  const pr = $("#pricing").value;
  const uw = $("#uw").value;
  const ch = $("#channel").value;
  const ad = $("#ads").value;

  // Olay seç (weighted random)
  const ev = weightedPick(CONFIG.events);

  // GWP ve LR oluştur
  const base = CONFIG.baseGWP;
  const mixVol = CONFIG.pricing[pr].volMul * CONFIG.events.find(e=>e.name===ev.name).volMul
               * CONFIG.ads[ad].demand * CONFIG.channel[ch].demand;
  let gwp = base * mixVol;

  let lr = CONFIG.baseLR
         + CONFIG.pricing[pr].lrAdd
         + CONFIG.uw[uw].lrAdd
         + ev.lrAdd;

  lr = clamp(lr, 0.40, 1.50); // mantıklı sınırlar
  const commRate = CONFIG.channel[ch].comm;
  const adRate = CONFIG.ads[ad].rate;

  // Yıl içi ödemeler ve rezerv bazı
  const expectedLoss = gwp * lr;
  const paidLoss = expectedLoss * CONFIG.paidRatio;
  const reserveBase = expectedLoss * (1 - CONFIG.paidRatio);

  // İmaj güncelleme (hafif)
  state.brandScore += CONFIG.ads[ad].brand;
  if(ev.brand=="+") state.brandScore++;
  if(ev.brand=="-") state.brandScore--;

  // Geçici yıl verilerini tut
  state.current = {
    pr, uw, ch, ad, ev: ev.name,
    gwp, lr, commRate, adRate,
    paidLoss, reserveBase
  };
  state.locked = true;
  // UI güncelle
  $("#eventPill").textContent = "Olay: " + ev.name;
  $("#mGwp").textContent = gwp.toFixed(2);
  $("#mLR").textContent = (lr*100).toFixed(1) + "%";
  $("#mComm").textContent = (commRate*100).toFixed(1) + "%";
  $("#mAds").textContent = (adRate*100).toFixed(1) + "%";
  $("#mPaid").textContent = paidLoss.toFixed(2);
  $("#mResBase").textContent = reserveBase.toFixed(2);
  refreshUI();
});

// Yılı kapat (rezerv + vergi + sermaye)
$("#btnClose").addEventListener("click", ()=>{
  if(!state.locked || !state.current) return;
  const pol = $("#reservePolicy").value;
  const rp = CONFIG.reservePolicy[pol];

  // Bileşenler
  const c = state.current;
  const reserve = c.reserveBase * rp.mult;
  const commission = c.gwp * c.commRate;
  const ads = c.gwp * c.adRate;

  // Net kâr VÖ
  const preTax = c.gwp - (c.paidLoss + reserve) - commission - ads;
  const tax = preTax>0 ? preTax * state.taxRate : 0;
  const postTax = preTax - tax;
  state.capital += postTax;

  // Rejim testi
  const verdict = CONFIG.regimes[state.regime].test(state.capital, state.lowTrailPrev);

  // Medium rejimde trail bayrağını güncelle
  if(state.regime==="medium"){
    if(state.capital < 75){
      // bu yıl <75 ise (ikinci darbe ise FAIL zaten yukarıda verildi)
      state.lowTrailPrev = (verdict!=="OK"); // WARN → true, FAIL → true
    } else {
      state.lowTrailPrev = false;
    }
  }

  // Log satırı
  appendLog({
    year: state.year,
    ev: c.ev, pr: c.pr, uw: c.uw, ch: c.ch, ad: c.ad, pol: rp.label,
    gwp: c.gwp, lr: c.lr, paid: c.paidLoss, res: reserve, comm: commission, ads,
    preTax, tax, postTax, capital: state.capital
  });

  // Durum & UI
  const statusEl = $("#kStatus");
  if(verdict==="FAIL"){
    statusEl.textContent = "İflas!";
    $("#kpiStatus").className = "kpi bad";
    disableAll();
  } else {
    statusEl.textContent = verdict==="WARN" ? "Uyarı: Sermaye eşiğinin altında" : "Yıl kapandı";
    $("#kpiStatus").className = "kpi " + (verdict==="WARN" ? "warn" : "ok");
    $("#btnNext").disabled = false; // yeni yıla geçilebilir
  }

  state.locked = false;   // kapanış tamam
  state.current = null;
  refreshUI();
});

// Yeni yıla geç
$("#btnNext").addEventListener("click", ()=>{
  if($("#btnNext").disabled) return;
  state.year += 1;
  $("#btnNext").disabled = true;
  $("#eventBox").style.display = "none";
  $("#kStatus").textContent = "Yeni yıl";
  $("#kpiStatus").className = "kpi";
  refreshUI();
});

// Sıfırla
$("#btnReset").addEventListener("click", ()=>{
  state = {
    year:1, capital:100, brandScore:0, lowTrailPrev:false,
    regime: $("#regime").value || "medium",
    taxRate: parseFloat($("#tax").value || CONFIG.tax),
    locked:false, current:null
  };
  logBody.innerHTML = "";
  $("#eventBox").style.display = "none";
  $("#kStatus").textContent = "Başlangıç";
  $("#kpiStatus").className = "kpi";
  $("#btnNext").disabled = true;
  refreshUI();
});

/* ====== yardımcılar ====== */
function weightedPick(arr){
  const r = Math.random();
  let acc = 0;
  for(const x of arr){
    acc += x.p;
    if(r <= acc) return x;
  }
  return arr[arr.length-1];
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function appendLog(row){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${row.year}</td>
    <td>${row.ev}</td>
    <td>${labelPricing(row.pr)}</td>
    <td>${labelUW(row.uw)}</td>
    <td>${labelChannel(row.ch)}</td>
    <td>${labelAds(row.ad)}</td>
    <td>${row.pol}</td>
    <td>${fmt(row.gwp)}</td>
    <td>${(row.lr*100).toFixed(1)}%</td>
    <td>${fmt(row.paid)}</td>
    <td>${fmt(row.res)}</td>
    <td>${fmt(row.comm)}</td>
    <td>${fmt(row.ads)}</td>
    <td>${fmt(row.preTax)}</td>
    <td>${fmt(row.tax)}</td>
    <td>${fmt(row.postTax)}</td>
    <td>${fmt(row.capital)}</td>
  `;
  logBody.appendChild(tr);
}
function fmt(x){ return (x>=0? "" : "−") + Math.abs(x).toFixed(2); }
function labelPricing(k){ return k==="cheap"?"Ucuz":k==="mid"?"Orta":"Pahalı"; }
function labelUW(k){ return k==="loose"?"Gevşek":k==="mid"?"Orta":"Sıkı"; }
function labelChannel(k){ return k==="agent"?"Acente":k==="balanced"?"Dengeli":"Dijital"; }
function labelAds(k){ return k==="low"?"Düşük":k==="mid"?"Orta":"Yüksek"; }
function disableAll(){
  ["btnRoll","btnClose","btnNext"].forEach(id=>{ const e=$( "#"+id ); e.disabled=true; });
}
</script>
</body>
</html>
