<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher â€“ YÄ±llÄ±k Sigorta SimÃ¼lasyonu (MDP)</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a 20%,#0f172a);color:var(--ink)}
  header{padding:20px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:#0f172a;z-index:9}
  h1{margin:0;font-size:20px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .grid{display:grid;gap:16px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:16px}
  .card h2{margin:0 0 12px 0;font-size:16px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  select,input[type="number"],input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1023;color:#fff}
  .row{display:flex;gap:8px;align-items:center}
  .row>div{flex:1}
  .btn{appearance:none;border:1px solid #334155;background:#0b1023;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{border-color:#475569}
  .btn.primary{background:var(--accent);border-color:#22d3ee;color:#04121a;font-weight:600}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}
  th{color:#cbd5e1}
  .muted{color:var(--muted);font-size:12px}
  .ok{color:#22c55e}.warn{color:#fbbf24}.bad{color:#f87171}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:12px}
  .hr{height:1px;background:#1f2937;margin:12px 0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .right{display:flex;justify-content:flex-end;gap:8px}
  @media(max-width:980px){.cols-3,.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><h1>ğŸ•¹ï¸ Watcher â€” YÄ±llÄ±k Sigorta SimÃ¼lasyonu (vergi + rezerv + regÃ¼lasyon)</h1></header>
<div class="wrap">

  <!-- STRATEJÄ°LER -->
  <section class="grid cols-3">
    <div class="card">
      <h2>1) YÄ±l BaÅŸÄ± Stratejileri</h2>
      <label>Fiyatlama</label>
      <select id="price">
        <option value="cheap">Ucuz (rekabetÃ§i)</option>
        <option value="mid" selected>Orta</option>
        <option value="expensive">PahalÄ±</option>
      </select>
      <label>Underwriting (Risk Kabul)</label>
      <select id="uw">
        <option value="loose">GevÅŸek</option>
        <option value="neutral" selected>Orta</option>
        <option value="strict">SÄ±kÄ±</option>
      </select>
      <label>SatÄ±ÅŸ KanalÄ±</label>
      <select id="channel">
        <option value="agent">Acente AÄŸÄ±rlÄ±klÄ±</option>
        <option value="balanced" selected>Dengeli</option>
        <option value="digital">Dijital AÄŸÄ±rlÄ±klÄ±</option>
      </select>
      <label>Reklam & Ä°maj</label>
      <select id="ads">
        <option value="low">DÃ¼ÅŸÃ¼k</option>
        <option value="mid" selected>Orta</option>
        <option value="high">YÃ¼ksek</option>
      </select>
      <div class="hr"></div>
      <label>RegÃ¼lasyon (Zorluk)</label>
      <select id="regime">
        <option value="easy">Easy (gevÅŸek)</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard (sÄ±kÄ±)</option>
      </select>
      <label>Vergi OranÄ± (%)</label>
      <input id="tax" type="number" step="1" value="20"/>
      <label>BaÅŸlangÄ±Ã§ Sermayesi</label>
      <input id="capitalStart" type="number" step="1" value="100"/>
      <div class="hr"></div>
      <div class="right">
        <button class="btn" id="resetYear">YÄ±lÄ± SÄ±fÄ±rla</button>
      </div>
      <p class="muted">Not: Stratejiler <b>eÅŸ zamanlÄ± seÃ§ilir</b>, etkiler hesaplamada ardÄ±ÅŸÄ±k iÅŸlenir.</p>
    </div>

    <!-- PRIOR / POSTERIOR -->
    <div class="card">
      <h2>2) Åans OlaylarÄ± (Prior â†’ Posterior)</h2>
      <p class="muted">Prior olasÄ±lÄ±klarÄ± ve etkileri dÃ¼zenle. â€œAÄŸÄ±rlÄ±kla & Normalize Etâ€ ile stratejiye baÄŸlÄ± posterior oluÅŸtur.</p>
      <table id="priorTbl">
        <thead><tr><th>Olay</th><th>p (prior)</th><th>LR Î” (puan)</th><th>Hacim Ã§arpanÄ±</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="row">
        <button class="btn" id="posteriorBtn">Stratejiye GÃ¶re AÄŸÄ±rlÄ±kla & Normalize Et</button>
        <button class="btn" id="savePriors">Priors JSON Ä°ndir</button>
        <input type="file" id="loadPriors" accept="application/json" class="btn"/>
      </div>
      <div class="hr"></div>
      <h3>Posterior (kullanÄ±lacak)</h3>
      <table id="postTbl">
        <thead><tr><th>Olay</th><th>p (post)</th><th>LR Î”</th><th>Hacim Ã§arpanÄ±</th><th>AÄŸÄ±rlÄ±k notu</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- REZERV & SÄ°MÃœLASYON -->
    <div class="card">
      <h2>3) YÄ±l Sonu â€” Rezerv PolitikasÄ±</h2>
      <select id="reserve">
        <option value="conservative">Konservatif (Ã—1.20)</option>
        <option value="neutral" selected>NÃ¶tr (Ã—1.00)</option>
        <option value="aggressive">Agresif (Ã—0.80)</option>
      </select>
      <div class="hr"></div>
      <h2>4) SimÃ¼lasyon Parametreleri</h2>
      <label>Baz GWP</label><input id="baseGwp" type="number" value="100"/>
      <label>Baz LR (%)</label><input id="baseLR" type="number" value="65"/>
      <label>Komisyon (Acente / Dengeli / Dijital) %</label>
      <div class="row">
        <input id="cAgent" type="number" value="18"/><input id="cBalanced" type="number" value="12"/><input id="cDigital" type="number" value="5"/>
      </div>
      <label>Reklam (DÃ¼ÅŸÃ¼k / Orta / YÃ¼ksek) % GWP</label>
      <div class="row">
        <input id="aLow" type="number" value="1"/><input id="aMid" type="number" value="3"/><input id="aHigh" type="number" value="6"/>
      </div>
      <div class="hr"></div>
      <div class="right">
        <button class="btn primary" id="runYear">YÄ±lÄ± Ä°ÅŸlet</button>
        <button class="btn" id="sampleSpace">Ã–rneklem UzayÄ± (CSV)</button>
      </div>
      <p class="muted">SonuÃ§lar aÅŸaÄŸÄ±daki tabloda ve raporda gÃ¶rÃ¼nÃ¼r.</p>
    </div>
  </section>

  <!-- RAPORLAR -->
  <section class="grid cols-2">
    <div class="card">
      <h2>YÄ±l Sonu Hesap Ã–zeti</h2>
      <table id="resultTbl">
        <thead><tr><th>Olay</th><th>p</th><th>GWP</th><th>LR%</th><th>Kom%</th><th>Rek%</th><th>Net KÃ¢r VÃ–</th><th>Vergi</th><th>Net KÃ¢r VS</th><th>Yeni Sermaye</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h2>Toplam / RegÃ¼lasyon</h2>
      <div id="totals" class="mono"></div>
      <div class="hr"></div>
      <h3>YÄ±l AkÄ±ÅŸÄ±</h3>
      <ol class="muted">
        <li>YÄ±l baÅŸÄ±: Fiyat + UW + Kanal + Reklam seÃ§ildi.</li>
        <li>Posterior olasÄ±lÄ±klar stratejiye gÃ¶re Ã¼retildi.</li>
        <li>YÄ±l sonu: Rezerv politikasÄ± uygulandÄ±.</li>
        <li>Vergi sonrasÄ± net kÃ¢r sermayeye eklendi, iflas kontrolÃ¼ yapÄ±ldÄ±.</li>
      </ol>
    </div>
  </section>

  <!-- AÃ‡IKLAMA -->
  <section class="card">
    <h2>Notlar</h2>
    <ul class="muted">
      <li>Posterior aÄŸÄ±rlÄ±klandÄ±rma: strateji, olaylara <b>aÄŸÄ±rlÄ±k</b> verir (Ã¶r. rekabetÃ§i fiyat â†’ â€œFiyat savaÅŸÄ±â€ olayÄ± aÄŸÄ±rlÄ±k kazanÄ±r). AÄŸÄ±rlÄ±klar normalize edilerek p(post) Ã¼retilir.</li>
      <li>Rezerv politikasÄ± yÄ±l sonunda seÃ§ilir ve (Hasar Ã–demesi Ã— katsayÄ±) olarak gider yazÄ±lÄ±r.</li>
      <li>Kombine rasyo = LR + Komisyon + Reklam (rapor tablosunda dolaylÄ± izlenir).</li>
    </ul>
  </section>

</div>

<script>
/** --- Basit veri modeli --- **/
const state = {
  priors: [
    {key:"normal", name:"Normal",      p:0.60, lrDelta:0,   volMul:1.00},
    {key:"pricewar",name:"Fiyat SavaÅŸÄ±",p:0.20, lrDelta:5,  volMul:1.10},
    {key:"cat",     name:"Cat (Sel/Deprem)", p:0.15, lrDelta:12, volMul:1.00},
    {key:"pr",      name:"PR Krizi",   p:0.05, lrDelta:1,   volMul:0.90},
  ],
  posteriors: [],
  capital: 100,
  warned: false // Medium rejimde Z bandÄ±nda uyarÄ±
};

function $(id){return document.getElementById(id)}

function renderPriorTable(){
  const tb = $("priorTbl").querySelector("tbody");
  tb.innerHTML = "";
  state.priors.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td><input type="number" step="0.01" value="${r.p}" data-i="${i}" data-f="p"/></td>
      <td><input type="number" step="0.1" value="${r.lrDelta}" data-i="${i}" data-f="lrDelta"/></td>
      <td><input type="number" step="0.01" value="${r.volMul}" data-i="${i}" data-f="volMul"/></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", e=>{
      const i = +e.target.dataset.i;
      const f = e.target.dataset.f;
      let v = parseFloat(e.target.value);
      if(Number.isNaN(v)) v = 0;
      state.priors[i][f] = v;
    });
  });
}
renderPriorTable();

function strategyWeights(){
  const price = $("price").value;       // cheap/mid/expensive
  const uw = $("uw").value;             // loose/neutral/strict
  const ch = $("channel").value;        // agent/balanced/digital
  const ads = $("ads").value;           // low/mid/high

  // BaÅŸlangÄ±Ã§ tÃ¼m olay aÄŸÄ±rlÄ±klarÄ± 1.0
  const w = {normal:1, pricewar:1, cat:1, pr:1};

  // Fiyat etkisi
  if(price==="cheap"){ w.pricewar *= 1.35; w.normal *= 0.9; }
  if(price==="expensive"){ w.pricewar *= 0.8; w.normal *= 1.1; }

  // UW etkisi
  if(uw==="loose"){ w.cat *= 1.25; w.normal *= 0.95; }
  if(uw==="strict"){ w.cat *= 0.85; w.normal *= 1.05; }

  // Kanal etkisi
  if(ch==="digital"){ w.pr *= 1.05; w.normal *= 0.98; }
  if(ch==="agent"){ w.pr *= 0.95; w.normal *= 1.02; }

  // Reklam & imaj etkisi
  if(ads==="high"){ w.pr *= 0.85; w.normal *= 1.05; }
  if(ads==="low"){ w.pr *= 1.15; w.normal *= 0.95; }

  return w;
}

function computePosterior(){
  const w = strategyWeights();
  // p_post âˆ p_prior * w  (sonra normalize)
  let sum = 0;
  const post = state.priors.map(r=>{
    const weight = w[r.key] ?? 1;
    const raw = Math.max(0, r.p) * Math.max(0.0001, weight);
    sum += raw;
    return {...r, raw, weight};
  });
  state.posteriors = post.map(x=>({
    key:x.key, name:x.name,
    p: (sum>0? x.raw/sum : 0),
    lrDelta: x.lrDelta,
    volMul: x.volMul,
    note: `priorÃ—w = ${(x.p*100).toFixed(1)}% | w=${x.weight.toFixed(2)}`
  }));
  renderPosterior();
}

function renderPosterior(){
  const tb = $("postTbl").querySelector("tbody");
  tb.innerHTML = "";
  state.posteriors.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.p.toFixed(3)}</td>
      <td>${r.lrDelta}</td>
      <td>${r.volMul.toFixed(2)}</td>
      <td class="muted">${r.note}</td>`;
    tb.appendChild(tr);
  });
}

$("posteriorBtn").addEventListener("click", computePosterior);

// JSON kaydet/yÃ¼kle
$("savePriors").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state.priors, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "priors.json"; a.click();
  URL.revokeObjectURL(url);
});
$("loadPriors").addEventListener("change", async e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  const arr = JSON.parse(txt);
  if(Array.isArray(arr)&&arr.every(o=>o.key&&typeof o.p==="number")){
    state.priors = arr;
    renderPriorTable();
  } else alert("GeÃ§ersiz priors.json");
});


/** --- yardÄ±mcÄ±lar --- **/
function pct(n){return (n*100).toFixed(1)+"%";}
function band(cap){
  if(cap>=100) return "H";
  if(cap>=75)  return "M";
  if(cap>=50)  return "L";
  return "Z";
}
function commissionPct(channel){
  if(channel==="agent") return +$("cAgent").value/100;
  if(channel==="digital") return +$("cDigital").value/100;
  return +$("cBalanced").value/100;
}
function adsPct(level){
  if(level==="low") return +$("aLow").value/100;
  if(level==="high") return +$("aHigh").value/100;
  return +$("aMid").value/100;
}
function priceVolume(price){
  if(price==="cheap") return 1.30;
  if(price==="expensive") return 0.85;
  return 1.10;
}
function uwLRDelta(uw){
  if(uw==="loose") return +8;
  if(uw==="strict") return -6;
  return 0;
}

/** --- yÄ±l simÃ¼lasyonu --- **/
function runYear(){
  if(state.posteriors.length===0) computePosterior();

  // giriÅŸler
  const baseG = +$("baseGwp").value;
  const baseLR = +$("baseLR").value/100;
  const ch = $("channel").value;
  const adsLevel = $("ads").value;
  const price = $("price").value;
  const uw = $("uw").value;
  const tax = +$("tax").value/100;
  const reserve = $("reserve").value;
  const regime = $("regime").value;

  const vol = priceVolume(price);
  const com = commissionPct(ch);
  const adp = adsPct(adsLevel);
  const uwAdj = uwLRDelta(uw)/100;

  const reserveK = reserve==="conservative"?1.20:reserve==="aggressive"?0.80:1.00;

  const tbody = $("resultTbl").querySelector("tbody");
  tbody.innerHTML = "";

  let expectedNetAfterTax = 0;
  let expectedNewCap = 0;

  state.posteriors.forEach(ev=>{
    const p = ev.p;

    const GWP = baseG * vol * ev.volMul;
    const LR = Math.min(1, Math.max(0, baseLR + uwAdj + ev.lrDelta/100));
    const claimsPaid = GWP * LR;

    // Rezerv: yÄ±l sonu, hasar Ã¶demesine gÃ¶re katsayÄ±
    const reserveAmt = claimsPaid * (reserveK - 1 + 1); // = claimsPaid * reserveK

    const comm = GWP * com;
    const ads = GWP * adp;

    const preTax = GWP - (claimsPaid + reserveAmt) - comm - ads;
    const taxAmt = preTax>0 ? preTax*tax : 0;
    const afterTax = preTax - taxAmt;

    expectedNetAfterTax += p * afterTax;
    expectedNewCap += p * (state.capital + afterTax);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ev.name}</td>
      <td>${p.toFixed(3)}</td>
      <td>${GWP.toFixed(2)}</td>
      <td>${pct(LR)}</td>
      <td>${pct(com)}</td>
      <td>${pct(adp)}</td>
      <td class="${preTax>=0?'ok':'bad'}">${preTax.toFixed(2)}</td>
      <td>${taxAmt.toFixed(2)}</td>
      <td class="${afterTax>=0?'ok':'bad'}">${afterTax.toFixed(2)}</td>
      <td>${(state.capital + afterTax).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  // beklenen deÄŸerler
  const newCap = expectedNewCap; // zaten p ile aÄŸÄ±rlÄ±klÄ±
  const newBand = band(newCap);
  let fail = false, warn=false;
  if(regime==="hard"){ if(newCap<100) fail=true; }
  if(regime==="medium"){
    if(newCap<50){ if(state.warned) fail=true; else warn=true; }
  }
  if(regime==="easy"){ if(newCap<50) fail=true; }

  let regMsg = "";
  if(fail) regMsg = "âŒ Ä°flas koÅŸulu tetiklendi.";
  else if(warn){ regMsg = "âš ï¸ UyarÄ±: Z bandÄ±na indin. Gelecek yÄ±l toparlanmazsa iflas.";
                 state.warned = true; }
  else { regMsg = "âœ… RegÃ¼lasyon koÅŸullarÄ± saÄŸlandÄ±."; state.warned = false; }

  $("totals").innerHTML =
`BaÅŸlangÄ±Ã§ sermayesi: ${state.capital.toFixed(2)}
Beklenen Net KÃ¢r (Vergi SonrasÄ±): ${expectedNetAfterTax.toFixed(2)}
Beklenen yÄ±l sonu sermaye: ${newCap.toFixed(2)}  | Band: ${newBand}
Rejim: ${regime.toUpperCase()}  â†’ ${regMsg}`;

  // yÄ±lÄ± kapat
  state.capital = newCap;
}

$("runYear").addEventListener("click", runYear);
$("resetYear").addEventListener("click", ()=>{
  state.capital = +$("capitalStart").value;
  state.warned = false;
  $("resultTbl").querySelector("tbody").innerHTML = "";
  $("totals").textContent = "";
});


/** --- Ã–rneklem uzayÄ± / CSV --- **/
function toCSV(rows){
  const header = ["Olay","p(post)","LR_Delta","HacimMul","GWP_mul(all)","AÄŸÄ±rlÄ±k Notu"];
  const lines = [header.join(",")];
  rows.forEach(r=>lines.push([r.name, r.p.toFixed(4), r.lrDelta, r.volMul.toFixed(2), r.volAll.toFixed(2), `"${r.note}"`].join(",")));
  return lines.join("\n");
}
$("sampleSpace").addEventListener("click", ()=>{
  if(state.posteriors.length===0) computePosterior();
  const vol = priceVolume($("price").value);
  const rows = state.posteriors.map(r=>({...r, volAll: r.volMul * vol}));
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="orneklem_uzayi.csv"; a.click();
  URL.revokeObjectURL(url);
});

// Ä°lk posterior hesapla
computePosterior();
</script>
</body>
</html>
