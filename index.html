<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher â€” Orta YÄ±l Rezerv KararÄ± | Ã‡ift Ã–rneklem (incurred & real)</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1023;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a 25%,#0f172a);color:var(--ink)}
  header{position:sticky;top:0;background:#0f172a;padding:14px;border-bottom:1px solid #1f2937;z-index:5}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:14px}
  .grid{display:grid;gap:14px}
  .cols-3{grid-template-columns:1.25fr 1fr 1fr}
  .cols-2{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
  h2{margin:0 0 10px 0;font-size:16px}
  label{display:block;color:var(--muted);font-size:12px;margin:8px 0 4px}
  select,input{width:100%;padding:9px;border-radius:10px;border:1px solid #334155;background:var(--panel);color:#fff}
  .row{display:flex;gap:8px;align-items:center}
  .row>div{flex:1}
  .btn{appearance:none;border:1px solid #334155;background:var(--panel);color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#22d3ee;color:#04121a;font-weight:600}
  .btn.ghost{background:transparent}
  .hr{height:1px;background:#1f2937;margin:12px 0}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .ok{color:var(--ok)}.bad{color:var(--bad)}.warn{color:var(--warn)}
  .yearcard{background:#0b1023;border:1px solid #223047;border-radius:12px;padding:12px;margin-bottom:12px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:12px}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0b1023;border:1px solid #334155;border-radius:12px;padding:16px;max-width:620px;width:92%}
  .spinner{width:28px;height:28px;border:3px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choices .btn{flex:1}
  @media(max-width:980px){.cols-3,.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><h1>ğŸ•¹ï¸ Watcher â€” Orta YÄ±l Rezerv KararÄ± (incurred â†’ politika â†’ real)</h1></header>

<div class="wrap">

  <section class="grid cols-3">
    <!-- 1) YÄ±l baÅŸÄ± kararlarÄ± -->
    <div class="card">
      <h2>1) YÄ±l BaÅŸÄ± â€” Ãœretim Parametreleri</h2>
      <div class="row">
        <div>
          <label>Fiyatlama</label>
          <select id="price"><option value="cheap">Ucuz</option><option value="mid" selected>Orta</option><option value="exp">PahalÄ±</option></select>
        </div>
        <div>
          <label>Underwriting</label>
          <select id="uw"><option value="loose">GevÅŸek</option><option value="mid" selected>Orta</option><option value="strict">SÄ±kÄ±</option></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>SatÄ±ÅŸ KanalÄ±</label>
          <select id="channel"><option value="agent">Acente</option><option value="balanced" selected>Dengeli</option><option value="digital">Dijital</option></select>
        </div>
        <div>
          <label>PR / Reklam</label>
          <select id="ads"><option value="low">DÃ¼ÅŸÃ¼k</option><option value="mid" selected>Orta</option><option value="high">YÃ¼ksek</option></select>
        </div>
      </div>
      <div class="hr"></div>
      <label>Baz GWP (Gâ‚€)</label><input id="baseGwp" type="number" value="100"/>
      <label>BaÅŸlangÄ±Ã§ Sermayesi</label><input id="capitalStart" type="number" value="100"/>
      <div class="row">
        <div><label>Vergi OranÄ± (%)</label><input id="tax" type="number" value="20"/></div>
        <div><label>RegÃ¼lasyon</label><select id="regime"><option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option></select></div>
      </div>
      <div class="hr"></div>
      <button class="btn primary" id="startYear">YÄ±lÄ± BaÅŸlat</button>
      <button class="btn" id="resetGame">Oyunu SÄ±fÄ±rla</button>
      <p class="muted">AkÄ±ÅŸ: Ãœretim â†’ Olay (5sn suspense) â†’ incurred LR (rastgele) â†’ Rezerv yaklaÅŸÄ±mÄ± â†’ real LR (rastgele) â†’ Vergi â†’ TemettÃ¼.</p>
    </div>

    <!-- 2) Olay tablosu -->
    <div class="card">
      <h2>2) Olay OlasÄ±lÄ±klarÄ± & Î¼</h2>
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr><th>Olay</th><th>p</th><th>Î¼ (LR mean)</th><th>Ïƒ Ã§arpanÄ±</th><th>Hacim Ã§arpanÄ±</th><th>Ã–deme oranÄ± (yÄ±l iÃ§i)</th></tr></thead>
        <tbody id="eventBody"></tbody>
      </table>
      <div class="hr"></div>
      <div class="row">
        <div><label>Î¼ (Normal tabanÄ±, %)</label><input id="baseMu" type="number" value="65"/></div>
        <div><label>Ïƒâ‚€</label><input id="baseSigma" type="number" step="0.001" value="0.05"/></div>
      </div>
      <div class="row">
        <div><label>Ïƒ alt/Ã¼st</label><div class="row"><input id="sigmaMin" type="number" step="0.001" value="0.02"/><input id="sigmaMax" type="number" step="0.001" value="0.18"/></div></div>
        <div><label>OlayÄ± Ã‡ek</label><button class="btn" id="drawEvent">ğŸ² OlayÄ± Ã‡ek</button></div>
      </div>
      <div style="margin-top:8px"><span id="eventTag" class="pill" style="display:none"></span></div>
    </div>

    <!-- 3) Ä°nfo paneli -->
    <div class="card">
      <h2>Bilgi / Durum</h2>
      <div id="info" class="mono"></div>
    </div>
  </section>

  <!-- YÄ±llar alt alta -->
  <section class="card">
    <h2>YÄ±l KartlarÄ±</h2>
    <div id="years"></div>
  </section>
</div>

<!-- MODALS -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
// ---------- YardÄ±mcÄ±lar ----------
function $(id){return document.getElementById(id)}
function showModal(html){$("modalBox").innerHTML=html;$("modal").style.display="flex"}
function closeModal(){ $("modal").style.display="none" }
function clamp(x,a,b){return Math.max(a, Math.min(b, x))}
function pct(x, d=1){return (x*100).toFixed(d)+"%"}
function fmt(x, d=2){return Number(x).toFixed(d)}
function rngNormal(mu, sigma){ // Box-Muller
  let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
  const z = Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  return mu + sigma*z;
}
function rngTNormal(mu,sigma,a,b){ // basit tekrar Ã¶rnekleme
  for(let i=0;i<1000;i++){ const x=rngNormal(mu,sigma); if(x>=a && x<=b) return x; }
  return clamp(mu, a,b);
}
function zAlpha(alpha){ if(alpha>=0.975) return 1.96; if(alpha>=0.95) return 1.6449; if(alpha>=0.90) return 1.2816; return 0.8416; }
function band(cap){ if(cap>=100) return "H"; if(cap>=75) return "M"; if(cap>=50) return "L"; return "Z"; }

// ---------- Oyun Durumu ----------
const state = {
  year: 1,
  capital: 100,
  cumDividend: 0,
  warned: false,
  event: null,  // seÃ§ilen olay
  step: "idle", // idle -> eventDrawn -> incurredShown -> reserved -> closed
};

// ---------- Sabitler ----------
// Olaylar (strategiden baÄŸÄ±msÄ±z priors)
const EVENTS = [
  {key:"normal",    name:"Normal",       p:0.50,   mu:0.65, sigmaMul:1.00, volMul:1.00, paidShare:0.60},
  {key:"pricewar",  name:"Fiyat SavaÅŸÄ±", p:0.1667, mu:0.70, sigmaMul:1.05, volMul:1.05, paidShare:0.55},
  {key:"cat",       name:"CAT",          p:0.1667, mu:0.80, sigmaMul:1.20, volMul:1.00, paidShare:0.40},
  {key:"pr",        name:"PR Krizi",     p:0.1667, mu:0.66, sigmaMul:1.02, volMul:0.95, paidShare:0.50},
];

// Ïƒ katkÄ±larÄ± (kalibrasyon)
function sigmaDeltaPrice(v){ return v==="cheap"?+0.025 : v==="exp"?-0.015 : 0.00; }
function sigmaDeltaUW(v){    return v==="loose"?+0.035 : v==="strict"?-0.025 : 0.00; }
function sigmaDeltaChannel(v){return v==="agent"?+0.008 : v==="digital"?-0.004 : 0.00; }
function sigmaDeltaAds(v){   return v==="low"?+0.004 : v==="high"?-0.004 : 0.00; }

// GWP Ã§arpanlarÄ±
function priceVolume(v){ return v==="cheap"?1.30 : v==="exp"?0.85 : 1.10; }
function uwVolume(v){    return v==="loose"?1.10 : v==="strict"?0.90 : 1.00; }
function channelVolume(v){return v==="agent"?1.10 : v==="digital"?0.95 : 1.00; }
function prVolume(level){ const L={low:0, mid:1, high:2}[level]; return 1 + 0.08*L - 0.02*L*L; }

// Komisyon / PR maliyeti â€” SABÄ°T (UIâ€™da yok)
function commissionPct(channel){ if(channel==="agent") return 0.18; if(channel==="digital") return 0.05; return 0.12; }
function adsPct(level){ if(level==="low") return 0.01; if(level==="high") return 0.06; return 0.03; }

// RegÃ¼lasyon
function regulationCheck(newCap, regime, warned){
  if(regime==="hard"){ return {fail: newCap<100, warn:false}; }
  if(regime==="easy"){ return {fail: newCap<50, warn:false}; }
  if(newCap<50){ return {fail: warned, warn: !warned}; }
  return {fail:false, warn:false};
}

// ---------- UI ----------
function renderEventTable(){
  const tb = $("eventBody"); tb.innerHTML="";
  EVENTS.forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${e.name}</td>
       <td>${e.p.toFixed(4)}</td>
       <td>${(e.mu*100).toFixed(1)}%</td>
       <td>${e.sigmaMul.toFixed(2)}</td>
       <td>${e.volMul.toFixed(2)}</td>
       <td>${(e.paidShare*100).toFixed(0)}%</td>`;
    tb.appendChild(tr);
  });
}
renderEventTable();

function setInfo(text){ $("info").innerText = text; }

// ---------- BaÅŸlat / Reset ----------
$("resetGame").addEventListener("click", ()=>{
  state.year=1; state.capital=+$("capitalStart").value||100; state.cumDividend=0; state.warned=false;
  state.event=null; state.step="idle"; $("years").innerHTML=""; $("eventTag").style.display="none";
  setInfo(`Oyun sÄ±fÄ±rlandÄ±. Sermaye: ${fmt(state.capital)}. "YÄ±lÄ± BaÅŸlat" ile baÅŸlayÄ±n.`);
});

$("startYear").addEventListener("click", ()=>{
  if(state.year===1){ state.capital = +$("capitalStart").value || 100; }
  state.event=null; state.step="idle"; $("eventTag").style.display="none";
  setInfo(`YÄ±l ${state.year} baÅŸladÄ±. Sermaye: ${fmt(state.capital)}. "OlayÄ± Ã‡ek" ile devam edin.`);
});

// ---------- Olay Ã§ekimi (5sn suspense) ----------
$("drawEvent").addEventListener("click", ()=>{
  // suspense modal
  showModal(`
    <div style="display:flex;align-items:center;gap:10px">
      <span class="spinner"></span>
      <div>
        <b>Olay belirleniyorâ€¦</b><br/>
        <span class="muted">Piyasa zarlarÄ± atÄ±lÄ±yor, 5 saniye sonra sonuÃ§!</span>
      </div>
    </div>
  `);
  setTimeout(()=>{
    // olay seÃ§
    const u = Math.random(); let acc=0, ev=EVENTS[0];
    for(const e of EVENTS){ acc+=e.p; if(u<=acc){ ev=e; break; } }
    state.event = ev; state.step="eventDrawn";
    $("eventTag").style.display="inline-block";
    $("eventTag").textContent = `Olay: ${ev.name}`;
    closeModal();

    // incurred LR (ilk rastgele Ã§ekim â€” PRE daÄŸÄ±lÄ±m)
    const baseMu = (+$("baseMu").value||65)/100;
    // not: e.mu zaten tabloda set; istersen normal yÄ±l iÃ§in baseMu'ya eÅŸitleyebilirsin:
    // if(ev.key==="normal") ev.mu = baseMu;

    const baseSigma = +$("baseSigma").value || 0.05;
    const sMin = +$("sigmaMin").value || 0.02;
    const sMax = +$("sigmaMax").value || 0.18;

    const price=$("price").value, uw=$("uw").value, ch=$("channel").value, ads=$("ads").value;
    // Ïƒ_post (yÄ±l sonu) â€” strateji + olay Ã§arpanÄ±
    let sigma_post = baseSigma + sigmaDeltaPrice(price) + sigmaDeltaUW(uw) + sigmaDeltaChannel(ch) + sigmaDeltaAds(ads);
    sigma_post = clamp(sigma_post, sMin, sMax) * ev.sigmaMul;
    sigma_post = clamp(sigma_post, sMin, sMax);
    // Ïƒ_pre (yÄ±l iÃ§i incurred) â€” biraz daha dar belirsizlik
    const sigma_pre = clamp(0.7 * sigma_post, sMin*0.9, sMax);

    // GWP (yÄ±l iÃ§i Ã¼retim)
    const G0 = +$("baseGwp").value || 100;
    const GWP = G0 * priceVolume(price) * uwVolume(uw) * channelVolume(ch) * prVolume(ads) * ev.volMul;

    // incurred LR ~ TN(mu_event, sigma_pre, [0.40,1.30])
    const mu_event = ev.mu;
    const lr_inc = rngTNormal(mu_event, sigma_pre, 0.40, 1.30);

    const paidShare = ev.paidShare;
    const incurredAmt = GWP * lr_inc;
    const paidToDate = incurredAmt * paidShare;
    const outstanding = incurredAmt * (1 - paidShare);

    // Rezerv yaklaÅŸÄ±mÄ± sor (DÃ¼ÅŸÃ¼k / NÃ¶tr / Fazla)
    showModal(`
      <div>
        <b>YÄ±l iÃ§i gerÃ§ekleÅŸen tablo (incurred):</b>
        <pre class="mono">Olay: ${ev.name}
GWP: ${fmt(GWP)}
Incurred LR: ${(lr_inc*100).toFixed(1)}%  | Ïƒ_pre=${sigma_pre.toFixed(3)}
Ã–denen: ${fmt(paidToDate)}   | Muallak: ${fmt(outstanding)}</pre>
        <div class="hr"></div>
        <div><b>Rezerv yaklaÅŸÄ±mÄ±nÄ± seÃ§:</b> (yÄ±l sonu iÃ§in hedefi belirler)</div>
        <div class="choices">
          <button class="btn" data-res="low">DÃ¼ÅŸÃ¼k (Î±â‰ˆ0.80)</button>
          <button class="btn" data-res="mid">NÃ¶tr (Î±â‰ˆ0.90)</button>
          <button class="btn" data-res="high">Fazla (Î±â‰ˆ0.95)</button>
        </div>
      </div>
    `);

    // butonlar
    document.querySelectorAll('.choices .btn').forEach(b=>{
      b.onclick=()=>{
        const choice = b.dataset.res;
        closeModal();
        afterReserveChoice(choice, {GWP, mu_event, sigma_post, lr_inc, paidToDate, outstanding, ev});
      }
    });

  }, 5000);
});

// ---------- Rezerv seÃ§imi sonrasÄ±: real LR Ã§ek, P&L hesapla ----------
function afterReserveChoice(choice, ctx){
  const {GWP, mu_event, sigma_post, lr_inc, paidToDate, outstanding, ev} = ctx;

  const alpha = choice==="low"?0.80 : choice==="high"?0.95 : 0.90;
  const zq = zAlpha(alpha);
  const lr_star = clamp(mu_event + zq*sigma_post, 0.40, 1.30);

  // YÄ±l sonu gerÃ§ek LR ~ TN(mu_event, sigma_post, [0.40,1.30])
  const lr_real = rngTNormal(mu_event, sigma_post, 0.40, 1.30);
  const realClaims = GWP * lr_real;

  // SeÃ§ilen rezerv (hedefe gÃ¶re ayÄ±rmak istediÄŸi ek tutar)
  const chosenReserve = Math.max(0, GWP*lr_star - (paidToDate + outstanding));

  // Yetersizse aynÄ± yÄ±l strengthening (hemen P&L'e biner)
  const neededReserve = Math.max(0, realClaims - paidToDate);
  const finalReserve = Math.max(chosenReserve, neededReserve); // P&L'de yazÄ±lacak rezerv toplamÄ±

  // Masraflar (sabit oranlar)
  const comm = GWP * commissionPct($("channel").value);
  const adsCost = GWP * adsPct($("ads").value);

  const preTax = GWP - (paidToDate + finalReserve) - comm - adsCost;
  const taxRate = (+$("tax").value||0)/100;
  const tax = preTax>0 ? preTax*taxRate : 0;
  const afterTax = preTax - tax;

  // TemettÃ¼ kararÄ± (popup)
  if(afterTax<=0){
    showModal(`
      <div>
        <b>Vergi sonrasÄ± net kÃ¢r: ${fmt(afterTax)}</b><br/>
        <span class="muted">âŒ KÃ¢r olmadÄ±ÄŸÄ± iÃ§in temettÃ¼ daÄŸÄ±tÄ±lamaz.</span>
        <div class="hr"></div>
        <div class="choices"><button class="btn primary" id="closeNoDiv">Tamam</button></div>
      </div>
    `);
    $("closeNoDiv").onclick=()=>{ closeModal(); closeYear(0, {afterTax, GWP, lr_inc, lr_real, lr_star, paidToDate, outstanding, chosenReserve, finalReserve, comm, adsCost, preTax, tax, ev, choice}); };
  }else{
    showModal(`
      <div>
        <b>Vergi sonrasÄ± net kÃ¢r: ${fmt(afterTax)}</b><br/>
        <span class="muted">TemettÃ¼ Ã¶demek ister misiniz?</span>
        <div class="choices">
          <button class="btn" data-div="0">%0</button>
          <button class="btn" data-div="0.5">%50</button>
          <button class="btn" data-div="0.75">%75</button>
          <button class="btn" data-div="1">%100</button>
        </div>
      </div>
    `);
    document.querySelectorAll('.choices .btn').forEach(b=>{
      b.onclick=()=>{
        const divRate = parseFloat(b.dataset.div);
        closeModal();
        closeYear(divRate, {afterTax, GWP, lr_inc, lr_real, lr_star, paidToDate, outstanding, chosenReserve, finalReserve, comm, adsCost, preTax, tax, ev, choice});
      }
    });
  }
}

// ---------- YÄ±l kapanÄ±ÅŸÄ± ----------
function closeYear(divRate, k){
  const dividend = k.afterTax>0 ? k.afterTax*divRate : 0;
  const yearEndCap = state.capital + k.afterTax - dividend;

  // regÃ¼lasyon
  const reg = regulationCheck(yearEndCap, $("regime").value, state.warned);
  if(reg.warn) state.warned = true;
  const fail = reg.fail;

  state.cumDividend += dividend;

  const score = yearEndCap>0 ? (state.cumDividend / yearEndCap) * 100 : 0;

  // yÄ±l kartÄ±
  const y = document.createElement("div");
  y.className="yearcard";
  y.innerHTML = `
    <div><b>YÄ±l ${state.year}</b> â€” Olay: <span class="pill">${k.ev.name}</span> | Rezerv yaklaÅŸÄ±mÄ±: <span class="pill">${k.choice}</span></div>
    <div class="mono" style="margin-top:6px">
GWP=${fmt(k.GWP)}
incurred LR=${(k.lr_inc*100).toFixed(1)}%  | real LR=${(k.lr_real*100).toFixed(1)}%  | LR*=${(k.lr_star*100).toFixed(1)}% 
Ã–denen=${fmt(k.paidToDate)}  | Muallak=${fmt(k.outstanding)}  | SeÃ§ilen Rezerv=${fmt(k.chosenReserve)}  | P&L'de YazÄ±lan Rezerv=${fmt(k.finalReserve)}
Komisyon=${fmt(k.comm)}  | PR=${fmt(k.adsCost)}
Net KÃ¢r (VÃ–)=${fmt(k.preTax)} | Vergi=${fmt(k.tax)} | Net KÃ¢r (VS)=${fmt(k.afterTax)}
TemettÃ¼=${fmt(dividend)} | YÄ±l Sonu Sermaye=${fmt(yearEndCap)} | Band=${band(yearEndCap)}
    </div>`;
  $("years").prepend(y);

  // Ã¼st bilgi
  $("info").innerText =
`Sermaye: ${fmt(yearEndCap)} | Band: ${band(yearEndCap)}
KÃ¼mÃ¼latif TemettÃ¼: ${fmt(state.cumDividend)} | Skor: ${fmt(score,1)}%
Rejim=${$("regime").value.toUpperCase()} â†’ ${fail? "âŒ Ä°flas": (state.warned? "âš ï¸ UyarÄ±":"âœ… Uygun")}
Bir sonraki yÄ±l iÃ§in "YÄ±lÄ± BaÅŸlat" ile devam edin.`;

  // yÄ±lÄ± kapat
  state.capital = yearEndCap;
  state.year += 1;

  if(fail){
    showModal(`<div><b>Ä°flas tetiklendi.</b><div class="hr"></div><button class="btn" id="okFail">Tamam</button></div>`);
    $("okFail").onclick=()=>closeModal();
  }
}

// ---------- baÅŸlangÄ±Ã§ info ----------
setInfo(`HazÄ±r. "YÄ±lÄ± BaÅŸlat" ile baÅŸlayÄ±n.`);
</script>
</body>
</html>
