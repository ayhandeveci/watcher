<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher — Bayes Rezerv Oyunu</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444}
  body{margin:0;background:#0f172a;color:var(--ink);font-family:Inter,system-ui}
  header{padding:12px;border-bottom:1px solid #1f2937}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1280px;margin:auto;padding:14px;display:grid;gap:14px}
  .cols-4{display:grid;grid-template-columns:1.1fr 1fr 1fr 0.9fr;gap:14px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:10px;padding:12px}
  h2{margin:0 0 8px;font-size:15px}
  select,.btn{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1023;color:#fff}
  .btn{cursor:pointer;margin-top:6px}
  .btn.primary{background:var(--accent);color:#000;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px 8px;text-align:left}
  th{position:sticky;top:0;background:#0e162a}
  .face{font-size:40px}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#111827;padding:16px;border-radius:12px;width:90%;max-width:600px}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choices .btn{flex:1}
</style>
</head>
<body>
<header><h1>🕹️ Watcher — Bayes Rezerv Oyunu</h1></header>
<div class="wrap">
  <section class="cols-4">
    <!-- Panel 1 -->
    <div class="card">
      <h2>1) Yıl Başı — Portföy</h2>
      <label>Fiyatlama</label>
      <select id="price"><option value="cheap">Ucuz</option><option value="mid" selected>Orta</option><option value="exp">Pahalı</option></select>
      <label>Underwriting</label>
      <select id="uw"><option value="loose">Gevşek</option><option value="mid" selected>Orta</option><option value="strict">Sıkı</option></select>
      <label>Satış Kanalı</label>
      <select id="channel"><option value="agent">Acente</option><option value="balanced" selected>Dengeli</option><option value="digital">Dijital</option></select>
      <label>PR / Reklam</label>
      <select id="ads"><option value="low">Düşük</option><option value="mid" selected>Orta</option><option value="high">Yüksek</option></select>
      <button class="btn primary" id="startYear">Yılı Başlat</button>
      <button class="btn" id="drawEvent" disabled>🎲 Olayı Çek</button>
      <button class="btn" id="resetGame">Sıfırla</button>
      <div id="eventBadge" class="mono" style="margin-top:6px">Olay: —</div>
      <div id="midInfo" class="mono"></div>
    </div>
    <!-- Panel 2 -->
    <div class="card">
      <h2>2) Yıl Ortası — Rezerv</h2>
      <button class="btn" id="reserveBtn" disabled>ULR nasıl gelişir?</button>
      <div id="midPanel" class="mono" style="margin-top:8px"></div>
    </div>
    <!-- Panel 3 -->
    <div class="card">
      <h2>3) Yıl Sonu — Temettü</h2>
      <button class="btn" id="divBtn" disabled>Temettü Seçimi</button>
      <div id="endPanel" class="mono" style="margin-top:8px"></div>
    </div>
    <!-- Panel 4 -->
    <div class="card">
      <h2>4) CEO / Sermayedar</h2>
      <div id="ceoFace" class="face">🙂</div>
      <div id="ceoStats" class="mono"></div>
      <div id="statusBox" class="mono" style="margin-top:6px"></div>
    </div>
  </section>
  <!-- Alt tablo -->
  <section class="card">
    <h2>Yıl Sonuçları</h2>
    <table id="yearsTbl">
      <thead><tr>
        <th>Yıl</th><th>Olay</th><th>GWP</th><th>incLR</th><th>realLR</th><th>LR*</th>
        <th>Ödenen</th><th>Muallak</th><th>Rezerv</th><th>Kom.</th><th>PR</th>
        <th>VÖ</th><th>Vergi</th><th>VS</th><th>Temettü</th><th>Sermaye</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>
<!-- Modal -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>
<script>
const $=id=>document.getElementById(id);
const showModal=html=>{ $("modalBox").innerHTML=html; $("modal").style.display="flex"; };
const closeModal=()=>{ $("modal").style.display="none"; };
const fmt=(x,d=2)=>Number(x).toFixed(d);
function rngNormal(mu,sigma){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+sigma*z;}
function rngTNormal(mu,sigma,a,b){for(let i=0;i<2000;i++){const x=rngNormal(mu,sigma);if(x>=a&&x<=b)return x;}return Math.max(a,Math.min(b,mu));}

// Config
const CONFIG={capital0:100, tax:0.20, baseGwp:90, lrBounds:[0.35,1.4], earnedShare:0.5};

// State
const state={year:1, capital:CONFIG.capital0, cumDiv:0, warned:false, cache:null};

// Olay seti (olasılıkları değiştirmedim!)
const EVENTS=[
 {key:"normal",name:"Normal",mu:0.65,sigma:0.05,paidShare:0.6,blurb:"Her şey normal."},
 {key:"pricewar",name:"Fiyat Savaşı",mu:0.74,sigma:0.06,paidShare:0.52,blurb:"Agresif fiyat rekabeti."},
 {key:"cat",name:"CAT",mu:0.80,sigma:0.08,paidShare:0.7,blurb:"Felaket yılı, büyük hasar."},
 {key:"pr",name:"PR Krizi",mu:0.66,sigma:0.06,paidShare:0.58,blurb:"İmaj kaybı, masraflar artar."}
];

// Risk puanı
function portfolioRiskScore(price,uw,channel,ads){
  let s=0;
  if(price==="cheap")s+=0.6; else if(price==="exp")s-=0.4;
  if(uw==="loose")s+=0.8; else if(uw==="strict")s-=0.6;
  if(channel==="agent")s+=0.2; else if(channel==="digital")s-=0.1;
  if(ads==="high")s+=0.1; else if(ads==="low")s-=0.05;
  return Math.max(-1,Math.min(1,s/1.5));
}

// Başlat
$("startYear").onclick=()=>{
  $("drawEvent").disabled=false;
  state.cache=null;
};

// Olay çek
$("drawEvent").onclick=()=>{
  const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
  $("eventBadge").innerText=`Olay: ${ev.name} — ${ev.blurb}`;
  const GWP=CONFIG.baseGwp;
  const incLR=rngTNormal(ev.mu,ev.sigma,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);
  const earned=GWP*CONFIG.earnedShare;
  const incurred=earned*incLR;
  const paid=incurred*ev.paidShare;
  const outst=incurred-paid;
  const comm=GWP*0.12;
  const pr=GWP*(document.getElementById("ads").value==="high"?0.08:document.getElementById("ads").value==="low"?0.03:0.05);
  state.cache={ev,GWP,incLR,paid,outst,comm,pr,mu_post:ev.mu,sigma_post:ev.sigma};
  $("reserveBtn").disabled=false;
  $("midInfo").innerText=`incLR=%${fmt(incLR*100)} | Ödenen=${fmt(paid)} | Muallak=${fmt(outst)}`;
};

// Rezerv seçimi
$("reserveBtn").onclick=()=>{
  const k=state.cache; if(!k)return;
  showModal(`<h3>ULR nasıl gelişir?</h3>
    <div class="choices">
      <button class="btn" onclick="chooseReserve(0.60)">%60</button>
      <button class="btn" onclick="chooseReserve(0.75)">%75</button>
      <button class="btn" onclick="chooseReserve(0.90)">%90</button>
    </div>`);
};
window.chooseReserve=(lrStar)=>{
  closeModal();
  const k=state.cache;
  const need=k.GWP*lrStar-(k.paid+k.outst);
  k.lrStar=lrStar; k.resv=Math.max(0,need);
  $("divBtn").disabled=false;
  $("midPanel").innerText=`Seçilen ULR hedefi=%${fmt(lrStar*100)}, Rezerv=${fmt(k.resv)}`;
};

// Yıl sonu
$("divBtn").onclick=()=>{
  const k=state.cache; if(!k)return;
  // Portföy riskine göre realLR bias
  const rScore=portfolioRiskScore($("price").value,$("uw").value,$("channel").value,$("ads").value);
  const muAdj=k.mu_post+(0.10*rScore); // ±0.10 = ±10 puan
  const sigmaAdj=k.sigma_post*(1+1.0*Math.abs(rScore)); // ±100% oynaklık
  const realLR=rngTNormal(muAdj,sigmaAdj,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);
  k.realLR=realLR;
  const realNeed=k.GWP*realLR-(k.paid+k.outst);
  const delta=realNeed-k.resv;
  const pnlResv=delta;
  const VO=k.GWP-(k.paid+k.outst+k.resv)-k.comm-k.pr+pnlResv;
  const tax=VO>0?VO*CONFIG.tax:0;
  const VS=VO-tax;
  showModal(`<h3>Temettü Seç</h3>
    <div class="choices">
      <button class="btn" onclick="payDiv(0)">0</button>
      <button class="btn" onclick="payDiv(0.5)">%50</button>
      <button class="btn" onclick="payDiv(1)">%100</button>
    </div>`);
  window.payDiv=(f)=>{
    closeModal();
    const div=f>0?VS*f:0;
    state.cumDiv+=div;
    state.capital+=VS-div;
    const row=`<tr><td>${state.year}</td><td>${k.ev.name}</td><td>${fmt(k.GWP)}</td>
    <td>%${fmt(k.incLR*100)}</td><td>%${fmt(k.realLR*100)}</td><td>%${fmt(k.lrStar*100)}</td>
    <td>${fmt(k.paid)}</td><td>${fmt(k.outst)}</td><td>${fmt(k.resv)}</td>
    <td>${fmt(k.comm)}</td><td>${fmt(k.pr)}</td>
    <td>${fmt(VO)}</td><td>${fmt(tax)}</td><td>${fmt(VS)}</td><td>${fmt(div)}</td><td>${fmt(state.capital)}</td></tr>`;
    $("yearsTbl").querySelector("tbody").insertAdjacentHTML("beforeend",row);
    updateCEO();
    state.year++; $("drawEvent").disabled=true; $("reserveBtn").disabled=true; $("divBtn").disabled=true;
  };
};

// CEO panel
function updateCEO(){
  const ratio=state.cumDiv/state.capital;
  $("ceoStats").innerText=`Sermaye=${fmt(state.capital)} | Kümülatif Temettü=${fmt(state.cumDiv)} | Oran=%${fmt(ratio*100)}`;
  if(state.capital<50){$("ceoFace").innerText="💀";$("statusBox").innerText="İflas!";return;}
  if(ratio<0.1 && state.year>2){$("ceoFace").innerText="😡";$("statusBox").innerText="CEO görevden alındı!";return;}
  $("ceoFace").innerText= ratio>=0.2?"😃":"🙂";
  $("statusBox").innerText="Oyuna devam...";
}

// Reset
$("resetGame").onclick=()=>{location.reload();};
</script>
</body>
</html>
