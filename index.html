<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher â€” Rezerv DevamlÄ± | TemettÃ¼ SonrasÄ± | Vergi | RegÃ¼lasyon</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1023;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a 25%,#0f172a);color:var(--ink)}
  header{position:sticky;top:0;background:#0f172a;padding:14px;border-bottom:1px solid #1f2937;z-index:5}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:14px}
  .grid{display:grid;gap:14px}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-2{grid-template-columns:repeat(2,1fr)}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
  h2{margin:0 0 10px 0;font-size:16px}
  label{display:block;color:var(--muted);font-size:12px;margin:8px 0 4px}
  select,input{width:100%;padding:9px;border-radius:10px;border:1px solid #334155;background:var(--panel);color:#fff}
  .row{display:flex;gap:8px;align-items:center}
  .row>div{flex:1}
  .btn{appearance:none;border:1px solid #334155;background:var(--panel);color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#22d3ee;color:#04121a;font-weight:600}
  .hr{height:1px;background:#1f2937;margin:12px 0}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}
  th{color:#cbd5e1}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .ok{color:#22c55e}.bad{color:#ef4444}.warn{color:#f59e0b}
  @media(max-width:980px){.cols-3,.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header><h1>ğŸ•¹ï¸ Watcher â€” Rezerv DevamlÄ± | TemettÃ¼ Vergiden Sonra | Vergi | RegÃ¼lasyon</h1></header>

<div class="wrap">

  <section class="grid cols-3">
    <!-- YÄ±l baÅŸÄ± kararlarÄ± -->
    <div class="card">
      <h2>1) YÄ±l BaÅŸÄ± Stratejileri</h2>
      <label>Fiyatlama</label>
      <select id="price">
        <option value="cheap">Ucuz (rekabetÃ§i)</option>
        <option value="mid" selected>Orta</option>
        <option value="exp">PahalÄ±</option>
      </select>

      <label>Underwriting (Risk Kabul)</label>
      <select id="uw">
        <option value="loose">GevÅŸek</option>
        <option value="mid" selected>Orta</option>
        <option value="strict">SÄ±kÄ±</option>
      </select>

      <label>SatÄ±ÅŸ KanalÄ±</label>
      <select id="channel">
        <option value="agent">Acente AÄŸÄ±rlÄ±klÄ±</option>
        <option value="balanced" selected>Dengeli</option>
        <option value="digital">Dijital AÄŸÄ±rlÄ±klÄ±</option>
      </select>

      <label>PR / Reklam Seviyesi</label>
      <select id="ads">
        <option value="low">DÃ¼ÅŸÃ¼k</option>
        <option value="mid" selected>Orta</option>
        <option value="high">YÃ¼ksek</option>
      </select>

      <div class="hr"></div>
      <label>BaÅŸlangÄ±Ã§ Sermayesi</label>
      <input id="capitalStart" type="number" value="100"/>

      <label>Vergi OranÄ± (%)</label>
      <input id="tax" type="number" value="20"/>

      <label>RegÃ¼lasyon (Zorluk)</label>
      <select id="regime">
        <option value="easy">Easy (gevÅŸek)</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard (sÄ±kÄ±)</option>
      </select>

      <div class="hr"></div>
      <label>TemettÃ¼ OranÄ± (% / Vergi SonrasÄ± KÃ¢r)</label>
      <input id="divPayout" type="number" value="30"/>

      <div class="hr"></div>
      <button class="btn" id="resetGame">Oyunu SÄ±fÄ±rla</button>
      <p class="muted">Not: TemettÃ¼ her zaman <b>vergiden sonra</b> uygulanÄ±r.</p>
    </div>

    <!-- Olaylar ve LR Î¼ -->
    <div class="card">
      <h2>2) Olay OlasÄ±lÄ±klarÄ± & LR Ortalama (Î¼)</h2>
      <p class="muted">OlasÄ±lÄ±klar stratejiden baÄŸÄ±msÄ±zdÄ±r (prior sabit).</p>
      <table id="eventTbl">
        <thead>
          <tr><th>Olay</th><th>p</th><th>Î¼ (LR mean)</th><th>Ïƒ olay Ã§arpanÄ±</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hr"></div>
      <label>Baz GWP</label><input id="baseGwp" type="number" value="100"/>
      <label>Baz LR (Normal yÄ±l, Î¼ tabanÄ±)</label><input id="baseMu" type="number" value="65"/>
      <label>Ïƒâ‚€ (baz std sapma)</label><input id="baseSigma" type="number" step="0.001" value="0.05"/>
      <label>Ïƒ alt/Ã¼st sÄ±nÄ±r</label>
      <div class="row"><input id="sigmaMin" type="number" step="0.001" value="0.02"/><input id="sigmaMax" type="number" step="0.001" value="0.15"/></div>
    </div>

    <!-- Rezerv ve modlar -->
    <div class="card">
      <h2>3) YÄ±l Sonu Rezerv PolitikasÄ±</h2>
      <label>Rezerv YaklaÅŸÄ±mÄ±</label>
      <select id="reserve">
        <option value="conservative">Konservatif (Î±=0.95)</option>
        <option value="neutral" selected>NÃ¶tr (Î±=0.90)</option>
        <option value="aggressive">Agresif (Î±=0.80)</option>
      </select>
      <div class="hr"></div>
      <h3>Ã‡alÄ±ÅŸtÄ±rma Modu</h3>
      <select id="mode">
        <option value="expected" selected>Beklenen DeÄŸer (olasÄ±lÄ±kla aÄŸÄ±rlÄ±klÄ±)</option>
        <option value="single">Tek Yol SimÃ¼lasyonu (rastgele olay & LR)</option>
      </select>
      <div class="hr"></div>
      <button class="btn primary" id="runYear">YÄ±lÄ± Ä°ÅŸlet</button>
      <button class="btn" id="exportCSV">SonuÃ§ CSV</button>
      <p class="muted">DevamlÄ± rezerv: GeÃ§en yÄ±lÄ±n LR* âˆ’ LR_real farkÄ±, bu yÄ±l baÅŸÄ±nda release/strengthening olarak sermayeye yansÄ±tÄ±lÄ±r.</p>
    </div>
  </section>

  <section class="grid cols-2">
    <div class="card">
      <h2>YÄ±l Sonu Hesap Ã–zeti</h2>
      <table id="resultTbl">
        <thead>
          <tr>
            <th>Olay</th><th>p</th><th>GWP</th><th>LR_real</th>
            <th>LR*</th><th>Kom%</th><th>Rek%</th>
            <th>Net KÃ¢r VÃ–</th><th>Vergi</th><th>Net KÃ¢r VS</th>
            <th>TemettÃ¼</th><th>YÄ±l Sonu Sermaye</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Toplam / RegÃ¼lasyon</h2>
      <div id="totals" class="mono"></div>
      <div class="hr"></div>
      <h3>Rezerv Hareketleri</h3>
      <div id="reserveInfo" class="mono"></div>
      <div class="hr"></div>
      <h3>AkÄ±ÅŸ</h3>
      <ol class="muted">
        <li>YÄ±l baÅŸÄ±: Fiyat + UW + Kanal + PR seÃ§ildi.</li>
        <li>Olay (prior) â†’ Î¼; strateji â†’ Ïƒ; LR_real ~ N(Î¼,Ïƒ).</li>
        <li>YÄ±l sonu: Rezerv politikasÄ± (Î±) â†’ LR* = Î¼ + zÎ±Â·Ïƒ.</li>
        <li>Vergi sonrasÄ± â†’ TemettÃ¼ â†’ Sermaye; regÃ¼lasyon kontrolÃ¼.</li>
        <li>Gelecek yÄ±l baÅŸÄ±: (LR* - LR_real)Ã—GWP, release/strengthening olarak sermayeye yansÄ±r.</li>
      </ol>
    </div>
  </section>

</div>

<script>
// ---------- YardÄ±mcÄ±lar ----------
function $(id){return document.getElementById(id)}
function pct(x){return (x*100).toFixed(1)+"%"}
function clamp(x,a,b){return Math.max(a, Math.min(b, x))}
function rngNormal(mu, sigma){
  // Box-Muller
  let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random();
  const z = Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  return mu + sigma*z;
}
const Z = {0.80:1.2816, 0.90:1.2816, 0.95:1.6449, 0.975:1.96}; // 0.90 ve 0.80 iÃ§in aynÄ± alÄ±nabilir/isteÄŸe gÃ¶re ayrÄ±ÅŸtÄ±r
function zAlpha(alpha){ if(alpha>=0.975) return 1.96; if(alpha>=0.95) return 1.6449; if(alpha>=0.90) return 1.2816; return 0.8416; }

// ---------- Durum ----------
const state = {
  capital: 100,
  cumDividend: 0,
  warned: false,
  pendingReserveDelta: 0, // geÃ§en yÄ±ldan bu yÄ±la taÅŸÄ±nan (LR* - LR_real)*GWP : + ise release (sermayeye ek), - ise strengthening (sermayeden dÃ¼ÅŸ)
  lastYear: null,
  // Priorlar sabit (stratejiden baÄŸÄ±msÄ±z)
  events: [
    {key:"normal", name:"Normal",     p:0.50, mu:0.65, sigmaMul:1.00},
    {key:"pricewar",name:"Fiyat SavaÅŸÄ±", p:0.1667, mu:0.70, sigmaMul:1.05},
    {key:"cat",    name:"Cat (Sel/Deprem)", p:0.1667, mu:0.80, sigmaMul:1.20},
    {key:"pr",     name:"PR Krizi",   p:0.1667, mu:0.66, sigmaMul:1.02},
  ],
  rows: [] // son yÄ±lÄ±n tablo satÄ±rlarÄ± (CSV iÃ§in)
};

function renderEventTable(){
  const tb = $("eventTbl").querySelector("tbody");
  tb.innerHTML = "";
  state.events.forEach((e,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.name}</td>
      <td>${e.p.toFixed(4)}</td>
      <td><input type="number" step="0.001" value="${e.mu*100}" data-i="${i}" data-f="mu"/></td>
      <td><input type="number" step="0.01" value="${e.sigmaMul}" data-i="${i}" data-f="sigmaMul"/></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("change", e=>{
      const i = +e.target.dataset.i;
      const f = e.target.dataset.f;
      let v = parseFloat(e.target.value);
      if(f==="mu"){ state.events[i].mu = (v||0)/100; }
      else if(f==="sigmaMul"){ state.events[i].sigmaMul = v||1; }
      renderEventTable(); // gÃ¼ncel deÄŸerleri gÃ¶ster (format)
    });
  });
}
renderEventTable();

// ---------- Strateji â†’ Ïƒ katkÄ±larÄ± ----------
function sigmaDeltaPrice(val){
  if(val==="cheap") return +0.03;
  if(val==="exp")   return -0.02;
  return 0.00;
}
function sigmaDeltaUW(val){
  if(val==="loose") return +0.04;
  if(val==="strict")return -0.03;
  return 0.00;
}
function sigmaDeltaChannel(val){
  if(val==="agent")    return +0.01;
  if(val==="digital")  return -0.005;
  return 0.00;
}
function sigmaDeltaAds(val){
  if(val==="low")  return +0.005;
  if(val==="high") return -0.005;
  return 0.00;
}
function commissionPct(channel){
  // kanca: sonra detaylandÄ±racaÄŸÄ±z
  if(channel==="agent") return 0.18;
  if(channel==="digital") return 0.05;
  return 0.12;
}
function adsPct(level){
  if(level==="low") return 0.01;
  if(level==="high") return 0.06;
  return 0.03;
}
function priceVolume(price){
  if(price==="cheap") return 1.30;
  if(price==="exp") return 0.85;
  return 1.10;
}

// ---------- Rezerv Î± ----------
function reserveAlpha(val){
  if(val==="conservative") return 0.95;
  if(val==="aggressive")   return 0.80;
  return 0.90;
}

// ---------- RegÃ¼lasyon ----------
function band(cap){
  if(cap>=100) return "H";
  if(cap>=75)  return "M";
  if(cap>=50)  return "L";
  return "Z";
}
function regulationCheck(newCap, regime, warnedFlag){
  if(regime==="hard"){ return {fail: newCap<100, warn:false} }
  if(regime==="easy"){ return {fail: newCap<50, warn:false} }
  // medium
  if(newCap<50){ return {fail: warnedFlag, warn: !warnedFlag} }
  return {fail:false, warn:false}
}

// ---------- YÄ±l Ã§alÄ±ÅŸtÄ±r ----------
function runYear(){
  // 0) Parametreler
  const price = $("price").value;
  const uw = $("uw").value;
  const channel = $("channel").value;
  const ads = $("ads").value;

  const baseG = +$("baseGwp").value || 100;
  const baseMu = (+$("baseMu").value || 65)/100;
  const baseSigma = +$("baseSigma").value || 0.05;
  const sMin = +$("sigmaMin").value || 0.02;
  const sMax = +$("sigmaMax").value || 0.15;

  const vol = priceVolume(price);
  const com = commissionPct(channel);
  const adp = adsPct(ads);

  const sigmaBaseAdj =
    sigmaDeltaPrice(price) +
    sigmaDeltaUW(uw) +
    sigmaDeltaChannel(channel) +
    sigmaDeltaAds(ads);

  const alpha = reserveAlpha($("reserve").value);
  const zq = zAlpha(alpha);

  const taxRate = (+$("tax").value || 0)/100;
  const regime = $("regime").value;
  const mode = $("mode").value;
  const divRate = Math.max(0, Math.min(1, (+$("divPayout").value || 0)/100));

  // 1) GeÃ§en yÄ±l rezerv farkÄ±nÄ± (release/strengthening) YIL BAÅINDA sermayeye yansÄ±t
  let reserveMovementThisYear = state.pendingReserveDelta || 0; // +: release, -: strengthening
  state.capital += reserveMovementThisYear;
  const reserveNote = `YÄ±l baÅŸÄ± rezerv hareketi: ${reserveMovementThisYear>=0?'+':''}${reserveMovementThisYear.toFixed(2)}`;

  // 2) OlaylarÄ±n Î¼'lerini baseMu'ya gÃ¶re ayarla (kullanÄ±cÄ± editlerse zaten gÃ¼ncel)
  state.events.forEach(e=>{
    // e.mu zaten tabloda; istersen baseMu'dan yeniden tÃ¼retmek iÃ§in burada gÃ¼ncelleyebilirsin.
    // Ã–rn: if (e.key==="normal") e.mu = baseMu;
  });

  // 3) Bu yÄ±lÄ±n Ïƒ formÃ¼lÃ¼ (olay Ã§arpanÄ± ile)
  function sigmaForEvent(ev){
    const s = clamp(baseSigma + sigmaBaseAdj, sMin, sMax) * ev.sigmaMul;
    return clamp(s, sMin, sMax);
  }

  // 4) Hesaplama: Beklenen DeÄŸer modu veya Tek Yol SimÃ¼lasyonu
  const tbody = $("resultTbl").querySelector("tbody");
  tbody.innerHTML = "";
  state.rows = [];

  let expectedAfterTax = 0;
  let expectedDividend = 0;
  let expectedYearEndCap = 0;

  let sampled = null; // Tek yol modu iÃ§in tutulan kayÄ±t
  let pendingReserveNext = 0; // gelecek yÄ±l baÅŸÄ±nda yansÄ±tÄ±lacak delta (LR* - LR_real)*GWP â€” beklenen/tek yol

  // GWP: strateji hacim Ã§arpanÄ±
  const GWP_base = baseG * vol;

  if(mode==="expected"){
    // Her olay iÃ§in p ile aÄŸÄ±rlÄ±kla
    state.events.forEach(ev=>{
      const p = ev.p;
      const mu = ev.mu; // olay Î¼
      const sigma = sigmaForEvent(ev);
      // Beklenen deÄŸer modunda LR_real'Ä±n beklenenini mu olarak alÄ±rÄ±z
      const LR_real = mu; // E[LR] = mu
      const LR_star = clamp(mu + zq*sigma, 0.40, 1.30);

      const GWP = GWP_base; // burada ev Ã¶zel hacim yok; istenirse eklenebilir
      const claimsPaid = GWP * LR_real; // basit model: yÄ±l iÃ§i gerÃ§ekleÅŸen Ã¶deme ~ mu

      // Bu yÄ±l ayrÄ±lan rezerv: LR* hedefi ile kalan yÃ¼kÃ¼mlÃ¼lÃ¼k
      const reserveSet = Math.max(0, GWP*LR_star - claimsPaid);

      const comm = GWP * com;
      const adsCost = GWP * adp;

      const preTax = GWP - (claimsPaid + reserveSet) - comm - adsCost;
      const tax = preTax>0 ? preTax*taxRate : 0;
      const afterTax = preTax - tax;

      const dividend = afterTax>0 ? afterTax*divRate : 0;
      const yearEndCap = state.capital + afterTax - dividend;

      // gelecek yÄ±l baÅŸÄ± iÃ§in beklenen rezerv farkÄ± (burada 0; Ã§Ã¼nkÃ¼ LR_real=mu, release/strengthening farkÄ±nÄ± bir sonraki yÄ±l gerÃ§ek LR ile gÃ¶rmek istersek tek yol modunu kullanÄ±rÄ±z)
      const reserveDeltaNext = GWP*(LR_star - LR_real);

      expectedAfterTax += p*afterTax;
      expectedDividend += p*dividend;
      expectedYearEndCap += p*yearEndCap;
      pendingReserveNext += p*reserveDeltaNext;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ev.name}</td>
        <td>${p.toFixed(3)}</td>
        <td>${GWP.toFixed(2)}</td>
        <td>${(LR_real*100).toFixed(1)}%</td>
        <td>${(LR_star*100).toFixed(1)}%</td>
        <td>${pct(com)}</td>
        <td>${pct(adp)}</td>
        <td class="${preTax>=0?'ok':'bad'}">${preTax.toFixed(2)}</td>
        <td>${tax.toFixed(2)}</td>
        <td class="${afterTax>=0?'ok':'bad'}">${afterTax.toFixed(2)}</td>
        <td>${dividend.toFixed(2)}</td>
        <td>${yearEndCap.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);

      state.rows.push({
        event: ev.name, p, GWP, LR_real, LR_star, com, adp,
        preTax, tax, afterTax, dividend, yearEndCap
      });
    });

  } else { // Tek yol: bir olay rastgele seÃ§, LR_real ~ N(mu, sigma) Ã§ek
    // Olay seÃ§
    const u = Math.random();
    let acc = 0, ev = state.events[0];
    for(const e of state.events){ acc += e.p; if(u<=acc){ ev=e; break; } }

    const mu = ev.mu;
    const sigma = sigmaForEvent(ev);
    let LR_real = rngNormal(mu, sigma);
    LR_real = clamp(LR_real, 0.40, 1.30);

    const LR_star = clamp(mu + zq*sigma, 0.40, 1.30);

    const GWP = GWP_base;
    const claimsPaid = GWP * LR_real;
    const reserveSet = Math.max(0, GWP*LR_star - claimsPaid);
    const comm = GWP * com;
    const adsCost = GWP * adp;

    const preTax = GWP - (claimsPaid + reserveSet) - comm - adsCost;
    const tax = preTax>0 ? preTax*taxRate : 0;
    const afterTax = preTax - tax;

    const dividend = afterTax>0 ? afterTax*divRate : 0;
    const yearEndCap = state.capital + afterTax - dividend;

    // Gelecek yÄ±l baÅŸÄ±nda yansÄ±yacak rezerv farkÄ±
    const reserveDeltaNext = GWP*(LR_star - LR_real);

    expectedAfterTax = afterTax;
    expectedDividend = dividend;
    expectedYearEndCap = yearEndCap;
    pendingReserveNext = reserveDeltaNext;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ev.name}</td>
      <td>â€”</td>
      <td>${GWP.toFixed(2)}</td>
      <td>${(LR_real*100).toFixed(1)}%</td>
      <td>${(LR_star*100).toFixed(1)}%</td>
      <td>${pct(com)}</td>
      <td>${pct(adp)}</td>
      <td class="${preTax>=0?'ok':'bad'}">${preTax.toFixed(2)}</td>
      <td>${tax.toFixed(2)}</td>
      <td class="${afterTax>=0?'ok':'bad'}">${afterTax.toFixed(2)}</td>
      <td>${dividend.toFixed(2)}</td>
      <td>${yearEndCap.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);

    state.rows.push({
      event: ev.name, p:null, GWP, LR_real, LR_star, com, adp,
      preTax, tax, afterTax, dividend, yearEndCap
    });
    sampled = {event: ev.name, LR_real, LR_star, reserveDeltaNext};
  }

  // 5) KÃ¼mÃ¼latif temettÃ¼ & skor
  state.cumDividend += expectedDividend;
  const score = (state.cumDividend / (+$("capitalStart").value || 1)) * 100;

  // 6) RegÃ¼lasyon kontrolÃ¼ (temettÃ¼ dÃ¼ÅŸÃ¼lmÃ¼ÅŸ beklenen sermaye ile)
  const reg = regulationCheck(expectedYearEndCap, regime, state.warned);
  let regMsg = "âœ… RegÃ¼lasyon koÅŸullarÄ± saÄŸlandÄ±.";
  if(reg.fail) regMsg = "âŒ Ä°flas koÅŸulu tetiklendi.";
  else if(reg.warn){ regMsg = "âš ï¸ UyarÄ±: Z bandÄ±na indin. Gelecek yÄ±l toparlanmazsa iflas."; }
  state.warned = reg.warn ? true : (reg.fail ? state.warned : false);

  // 7) YÄ±lÄ± kapat: sermaye gÃ¼ncelle, gelecek yÄ±l baÅŸÄ± rezerv farkÄ±nÄ± kaydet
  state.capital = expectedYearEndCap;
  state.pendingReserveDelta = pendingReserveNext;

  // 8) Ã–zetler
  $("totals").innerHTML =
`BaÅŸlangÄ±Ã§ sermayesi (yÄ±l baÅŸÄ±, rezerv hareketi sonrasÄ± dahil): ${state.capital.toFixed(2)}
Beklenen Net KÃ¢r (Vergi SonrasÄ±): ${expectedAfterTax.toFixed(2)}
Beklenen TemettÃ¼ (VS sonrasÄ±): ${expectedDividend.toFixed(2)}
Beklenen yÄ±l sonu sermaye: ${expectedYearEndCap.toFixed(2)} | Band: ${band(expectedYearEndCap)}
KÃ¼mÃ¼latif TemettÃ¼: ${state.cumDividend.toFixed(2)}  | Skor: ${score.toFixed(1)}%
Rejim: ${regime.toUpperCase()} â†’ ${regMsg}`;

  const pendNote = `Gelecek yÄ±l baÅŸÄ±nda yansÄ±yacak rezerv farkÄ± (LR* - LR_real)*GWP: ${pendingReserveNext>=0?'+':''}${pendingReserveNext.toFixed(2)}`
  $("reserveInfo").innerText = `${reserveNote}\n${pendNote}`

  // 9) Ä°flas olduysa butonlarÄ± kilitleme (basit)
  if(reg.fail){
    alert("Ä°flas tetiklendi. Oyunu sÄ±fÄ±rlayabilirsiniz.");
  }
}

// CSV
$("exportCSV").addEventListener("click", ()=>{
  if(!state.rows.length){ alert("Ã–nce yÄ±lÄ± iÅŸlet."); return; }
  const lines = [];
  lines.push(["Event","p","GWP","LR_real","LR_star","Comm%","Ads%","PreTax","Tax","AfterTax","Dividend","YearEndCapital"].join(","));
  state.rows.forEach(r=>{
    lines.push([
      r.event,
      r.p===null?"":r.p.toFixed(4),
      r.GWP.toFixed(2),
      (r.LR_real*100).toFixed(2)+"%",
      (r.LR_star*100).toFixed(2)+"%",
      (r.com*100).toFixed(2)+"%",
      (r.adp*100).toFixed(2)+"%",
      r.preTax.toFixed(2),
      r.tax.toFixed(2),
      r.afterTax.toFixed(2),
      r.dividend.toFixed(2),
      r.yearEndCap.toFixed(2),
    ].join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="watcher_yil_sonu_ozet.csv"; a.click();
  URL.revokeObjectURL(url);
});

// Reset
$("resetGame").addEventListener("click", ()=>{
  state.capital = +$("capitalStart").value || 100;
  state.cumDividend = 0;
  state.warned = false;
  state.pendingReserveDelta = 0;
  state.rows = [];
  $("resultTbl").querySelector("tbody").innerHTML = "";
  $("totals").innerHTML = "";
  $("reserveInfo").innerHTML = "";
});

// Run
$("runYear").addEventListener("click", runYear);
</script>
</body>
</html>
