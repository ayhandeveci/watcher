<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher — Aktüeryal Rezerv Eğitimi (incurred → rezerv → real)</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1023;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a 25%,#0f172a);color:var(--ink)}
  header{position:sticky;top:0;background:#0f172a;padding:14px;border-bottom:1px solid #1f2937;z-index:5}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1260px;margin:0 auto;padding:14px;display:grid;gap:14px}
  .grid{display:grid;gap:14px}
  .cols-layout{grid-template-columns:1.4fr 1.6fr 0.9fr}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:14px}
  h2{margin:0 0 10px 0;font-size:16px}
  label{display:block;color:var(--muted);font-size:12px;margin:8px 0 4px}
  select,input{width:100%;padding:9px;border-radius:10px;border:1px solid #334155;background:var(--panel);color:#fff}
  .row{display:flex;gap:8px;align-items:center}
  .row>div{flex:1}
  .btn{appearance:none;border:1px solid #334155;background:var(--panel);color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#22d3ee;color:#04121a;font-weight:600}
  .btn.ghost{background:transparent}
  .hr{height:1px;background:#1f2937;margin:12px 0}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .ok{color:var(--ok)}.bad{color:var(--bad)}.warn{color:var(--warn)}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px 8px;text-align:left;vertical-align:top}
  th{color:#cbd5e1;position:sticky;top:0;background:#0e162a;z-index:1}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0b1023;border:1px solid #334155;border-radius:12px;padding:16px;max-width:640px;width:92%}
  .spinner{width:28px;height:28px;border:3px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choices .btn{flex:1}
  .face{font-size:42px;line-height:1}
</style>
</head>
<body>
<header><h1>🕹️ Watcher — Aktüeryal Rezerv Eğitimi</h1></header>

<div class="wrap grid cols-layout">

  <!-- SOL KOLON: Seçimler & Olay -->
  <section class="card">
    <h2>1) Yıl Başı — Üretim Parametreleri</h2>
    <div class="row">
      <div>
        <label>Fiyatlama</label>
        <select id="price"><option value="cheap">Ucuz</option><option value="mid" selected>Orta</option><option value="exp">Pahalı</option></select>
      </div>
      <div>
        <label>Underwriting</label>
        <select id="uw"><option value="loose">Gevşek</option><option value="mid" selected>Orta</option><option value="strict">Sıkı</option></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Satış Kanalı</label>
        <select id="channel"><option value="agent">Acente</option><option value="balanced" selected>Dengeli</option><option value="digital">Dijital</option></select>
      </div>
      <div>
        <label>PR / Reklam</label>
        <select id="ads"><option value="low">Düşük</option><option value="mid" selected>Orta</option><option value="high">Yüksek</option></select>
      </div>
    </div>
    <div class="hr"></div>
    <label>Baz GWP (G₀)</label><input id="baseGwp" type="number" value="100"/>
    <label>Başlangıç Sermayesi</label><input id="capitalStart" type="number" value="100"/>
    <div class="row">
      <div><label>Vergi Oranı (%)</label><input id="tax" type="number" value="20"/></div>
      <div><label>Regülasyon</label><select id="regime"><option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option></select></div>
    </div>
    <div class="hr"></div>
    <button class="btn primary" id="startYear">Yılı Başlat</button>
    <button class="btn" id="drawEvent">🎲 Olayı Çek</button>
    <button class="btn" id="resetGame">Oyunu Sıfırla</button>
    <p class="muted" style="margin-top:8px">Akış: Üretim → <b>Olay (suspense)</b> → <b>incurred LR</b> (rastgele) → <b>Rezerv yaklaşımı</b> → <b>real LR</b> (rastgele) → Vergi → Temettü.</p>

    <div class="hr"></div>
    <h2>2) Parametreler (μ/σ)</h2>
    <div class="row">
      <div><label>μ (Normal tabanı, %)</label><input id="baseMu" type="number" value="65"/></div>
      <div><label>σ₀</label><input id="baseSigma" type="number" step="0.001" value="0.05"/></div>
    </div>
    <div class="row">
      <div><label>σ alt/üst</label><div class="row"><input id="sigmaMin" type="number" step="0.001" value="0.02"/><input id="sigmaMax" type="number" step="0.001" value="0.18"/></div></div>
    </div>

    <div class="hr"></div>
    <div id="eventBadge" class="muted">Olay: —</div>
    <div id="midInfo" class="mono" style="margin-top:6px"></div>
  </section>

  <!-- ORTA KOLON: YIL SONU TABLOSU -->
  <section class="card">
    <h2>Yıl Sonuçları</h2>
    <div style="max-height:420px;overflow:auto;border:1px solid #223047;border-radius:10px">
      <table id="yearsTbl">
        <thead>
          <tr>
            <th>Yıl</th><th>Olay</th><th>GWP</th>
            <th>incLR</th><th>realLR</th><th>LR*</th>
            <th>Ödenen</th><th>Muallak</th><th>Seçilen Rezerv</th><th>P&L Rezerv</th>
            <th>Kom.</th><th>PR</th>
            <th>VÖ</th><th>Vergi</th><th>VS</th><th>Temettü</th><th>Yıl Sonu Sermaye</th><th>Band</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- SAĞ KOLON: CEO PANELİ -->
  <section class="card">
    <h2>CEO Paneli</h2>
    <div id="ceoFace" class="face">🙂</div>
    <div class="hr"></div>
    <div id="ceoStats" class="mono"></div>
    <div class="hr"></div>
    <div id="statusBox" class="mono"></div>
  </section>

</div>

<!-- MODALS -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
// ---------- Yardımcılar ----------
function $(id){return document.getElementById(id)}
function showModal(html){$("modalBox").innerHTML=html;$("modal").style.display="flex"}
function closeModal(){ $("modal").style.display="none" }
function clamp(x,a,b){return Math.max(a, Math.min(b, x))}
function pct(x, d=1){return (x*100).toFixed(d)+"%"}
function fmt(x, d=2){return Number(x).toFixed(d)}
function rngNormal(mu, sigma){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+sigma*z;}
function rngTNormal(mu,sigma,a,b){for(let i=0;i<1000;i++){const x=rngNormal(mu,sigma);if(x>=a&&x<=b)return x;}return clamp(mu,a,b);}
function zAlpha(alpha){if(alpha>=0.975)return 1.96;if(alpha>=0.95)return 1.6449;if(alpha>=0.90)return 1.2816;return 0.8416;}
function band(cap){if(cap>=100)return"H";if(cap>=75)return"M";if(cap>=50)return"L";return"Z";}

// ---------- Durum ----------
const state = {
  year:1, capital:100, cumDiv:0, warned:false, event:null, step:"idle",
  score:100 // CEO skoru (başlangıç 100)
};

// ---------- Olaylar (μ event-bazlı mantıklı; olasılık gizli) ----------
const EVENTS = [
  {key:"normal",    name:"Normal",       p:0.50,   mu:0.65, sigmaMul:1.00, volMul:1.00, paidShare:0.60},
  {key:"pricewar",  name:"Fiyat Savaşı", p:0.1667, mu:0.70, sigmaMul:1.05, volMul:1.05, paidShare:0.55},
  {key:"cat",       name:"CAT",          p:0.1667, mu:0.80, sigmaMul:1.20, volMul:1.00, paidShare:0.40},
  {key:"pr",        name:"PR Krizi",     p:0.1667, mu:0.66, sigmaMul:1.02, volMul:0.95, paidShare:0.50},
];

// σ katkıları
function sigmaDeltaPrice(v){return v==="cheap"?+0.025:v==="exp"?-0.015:0;}
function sigmaDeltaUW(v){return v==="loose"?+0.035:v==="strict"?-0.025:0;}
function sigmaDeltaChannel(v){return v==="agent"?+0.008:v==="digital"?-0.004:0;}
function sigmaDeltaAds(v){return v==="low"?+0.004:v==="high"?-0.004:0;}

// GWP çarpanları
function priceVolume(v){return v==="cheap"?1.30:v==="exp"?0.85:1.10;}
function uwVolume(v){return v==="loose"?1.10:v==="strict"?0.90:1.00;}
function channelVolume(v){return v==="agent"?1.10:v==="digital"?0.95:1.00;}
function prVolume(level){const L={low:0,mid:1,high:2}[level];return 1+0.08*L-0.02*L*L;}

// Komisyon/PR — sabit
function commissionPct(channel){if(channel==="agent")return 0.18;if(channel==="digital")return 0.05;return 0.12;}
function adsPct(level){if(level==="low")return 0.01;if(level==="high")return 0.06;return 0.03;}

// Regülasyon
function regulationCheck(newCap, regime, warned){
  if(regime==="hard")return{fail:newCap<100,warn:false};
  if(regime==="easy")return{fail:newCap<50,warn:false};
  if(newCap<50)return{fail:warned,warn:!warned};
  return{fail:false,warn:false};
}

// CEO paneli
function setFace(ratio){ // ratio = cumDiv / capital
  let face="🙂";
  if(ratio<0.10) face="☹️";
  else if(ratio<0.15) face="😐";
  $("ceoFace").textContent=face;
}
function renderCEO(){
  const ratio = state.capital>0 ? state.cumDiv/state.capital : 0;
  // Skoru oran etrafında merkezleyelim: %10 → 100, yukarı/aşağı lineer
  state.score = Math.round(clamp(100 + (ratio-0.10)*1000, 0, 200));
  setFace(ratio);
  $("ceoStats").innerText =
`Skor: ${state.score} / 200
Oran (Kümül. Temettü / Sermaye): ${(ratio*100).toFixed(1)}%`;
  $("statusBox").innerText =
`Yıl: ${state.year-1} tamamlandı | Sermaye: ${fmt(state.capital)} | Kümül. Temettü: ${fmt(state.cumDiv)}
Başlangıç skoru 100'dü; oran arttıkça skor yükselir. Yıl ≥ 2 ve oran < %10 → CEO işten çıkarılır.`;
}

// Başlangıç
renderCEO();
$("statusBox").innerText = `Oyun hazır. "Yılı Başlat" → "Olayı Çek" ile devam edin.`;

// Reset
$("resetGame").addEventListener("click", ()=>{
  state.year=1; state.capital=+$("capitalStart").value||100; state.cumDiv=0; state.warned=false; state.event=null; state.step="idle"; state.score=100;
  $("eventBadge").innerText="Olay: —"; $("midInfo").innerText="";
  document.querySelector("#yearsTbl tbody").innerHTML="";
  renderCEO();
  $("statusBox").innerText="Oyun sıfırlandı.";
});

// Yılı başlat
$("startYear").addEventListener("click", ()=>{
  if(state.year===1){ state.capital=+$("capitalStart").value||100; }
  state.event=null; state.step="idle";
  $("eventBadge").innerText="Olay: —"; $("midInfo").innerText=`Yıl ${state.year} başladı. Sermaye: ${fmt(state.capital)}.`;
});

// Olayı çek (5sn suspense)
$("drawEvent").addEventListener("click", ()=>{
  showModal(`
    <div style="display:flex;align-items:center;gap:10px">
      <span class="spinner"></span>
      <div>
        <b>Olay belirleniyor…</b><br/>
        <span class="muted">Piyasa zarları atılıyor, 5 saniye sonra açıklanacak.</span>
      </div>
    </div>
  `);
  setTimeout(()=>{
    const u=Math.random(); let acc=0, ev=EVENTS[0];
    for(const e of EVENTS){acc+=e.p;if(u<=acc){ev=e;break;}}
    state.event=ev; state.step="eventDrawn";
    $("eventBadge").innerText=`Olay: ${ev.name}`;
    closeModal();
    afterEventShowIncurred();
  },5000);
});

// Olaydan sonra incurred LR göster
function afterEventShowIncurred(){
  const ev = state.event; if(!ev) return;
  const price=$("price").value, uw=$("uw").value, ch=$("channel").value, ads=$("ads").value;

  const G0=+$("baseGwp").value||100;
  const GWP = G0 * priceVolume(price) * uwVolume(uw) * channelVolume(ch) * prVolume(ads) * ev.volMul;

  const baseSigma= +$("baseSigma").value||0.05;
  const sMin= +$("sigmaMin").value||0.02;
  const sMax= +$("sigmaMax").value||0.18;

  let sigma_post = baseSigma + sigmaDeltaPrice(price)+sigmaDeltaUW(uw)+sigmaDeltaChannel(ch)+sigmaDeltaAds(ads);
  sigma_post = clamp(sigma_post, sMin, sMax) * ev.sigmaMul;
  sigma_post = clamp(sigma_post, sMin, sMax);
  const sigma_pre = clamp(0.7*sigma_post, sMin*0.9, sMax);

  const mu_event = ev.mu;
  const lr_inc = rngTNormal(mu_event, sigma_pre, 0.40, 1.30);
  const incurredAmt = GWP * lr_inc;
  const paid = incurredAmt * ev.paidShare;
  const outstanding = incurredAmt - paid;

  $("midInfo").innerText =
`GWP=${fmt(GWP)} | incurred LR=${(lr_inc*100).toFixed(1)}% | σ_pre=${sigma_pre.toFixed(3)}
Ödenen=${fmt(paid)} | Muallak=${fmt(outstanding)}  → Rezerv yaklaşımı seçin (Düşük/Nötr/Fazla).`;

  showModal(`
    <div>
      <b>Yıl içi (incurred) görünüm</b>
      <pre class="mono">Olay: ${ev.name}
GWP: ${fmt(GWP)}
incurred LR: ${(lr_inc*100).toFixed(1)}% | σ_pre=${sigma_pre.toFixed(3)}
Ödenen: ${fmt(paid)} | Muallak: ${fmt(outstanding)}</pre>
      <div class="hr"></div>
      <div><b>Rezerv yaklaşımını seç:</b></div>
      <div class="choices">
        <button class="btn" data-res="low">Düşük (α≈0.80)</button>
        <button class="btn" data-res="mid">Nötr (α≈0.90)</button>
        <button class="btn" data-res="high">Fazla (α≈0.95)</button>
      </div>
    </div>
  `);

  document.querySelectorAll('.choices .btn').forEach(b=>{
    b.onclick=()=>{ closeModal(); finalizeYearWithReserve(b.dataset.res,{GWP,mu_event,sigma_post,lr_inc,paid,outstanding,ev, price,uw,ch,ads}); }
  });
}

// Rezerv seçildikten sonra real LR çek, vergi & temettü, satır ekle
function finalizeYearWithReserve(choice, ctx){
  const {GWP,mu_event,sigma_post,lr_inc,paid,outstanding,ev, ch, ads} = ctx;

  const alpha = choice==="low"?0.80 : choice==="high"?0.95 : 0.90;
  const zq = zAlpha(alpha);
  const lr_star = clamp(mu_event + zq*sigma_post, 0.40, 1.30);

  const lr_real = rngTNormal(mu_event, sigma_post, 0.40, 1.30);
  const realClaims = GWP * lr_real;

  const chosenReserve = Math.max(0, GWP*lr_star - (paid+outstanding)); // oyuncunun politikası
  const neededReserve = Math.max(0, realClaims - paid);                // gerçekleşme gereği
  const finalReserve = Math.max(chosenReserve, neededReserve);         // P&L'de yazılan

  const comm = GWP * commissionPct(ch);
  const adsCost = GWP * adsPct(ads);

  const preTax = GWP - (paid + finalReserve) - comm - adsCost;
  const taxRate=(+$("tax").value||0)/100;
  const tax = preTax>0 ? preTax*taxRate : 0;
  const afterTax = preTax - tax;

  // Temettü popup
  if(afterTax<=0){
    showModal(`<div><b>Vergi sonrası net kâr: ${fmt(afterTax)}</b><br/><span class="muted">❌ Kâr yok; temettü dağıtılamaz.</span><div class="hr"></div><button class="btn primary" id="okNoDiv">Tamam</button></div>`);
    $("okNoDiv").onclick=()=>{ closeModal(); closeYear(0); };
  }else{
    showModal(`
      <div>
        <b>Vergi sonrası net kâr: ${fmt(afterTax)}</b><br/><span class="muted">Temettü ödemek ister misiniz?</span>
        <div class="choices">
          <button class="btn" data-div="0">%0</button>
          <button class="btn" data-div="0.5">%50</button>
          <button class="btn" data-div="0.75">%75</button>
          <button class="btn" data-div="1">%100</button>
        </div>
      </div>
    `);
    document.querySelectorAll('.choices .btn').forEach(b=>{
      b.onclick=()=>{ const rate=parseFloat(b.dataset.div); closeModal(); closeYear(rate); };
    });
  }

  const regime = $("regime").value;
  const tbody=document.querySelector("#yearsTbl tbody");
  function closeYear(divRate){
    const dividend = afterTax>0 ? afterTax*divRate : 0;
    const yearEndCap = state.capital + afterTax - dividend;

    // regülasyon
    const reg = regulationCheck(yearEndCap, regime, state.warned);
    if(reg.warn) state.warned = true;
    const fail = reg.fail;

    state.cumDiv += dividend;
    state.capital = yearEndCap;

    // CEO paneli & işten çıkarma
    const ratio = state.capital>0 ? state.cumDiv/state.capital : 0;
    renderCEO();
    if(state.year>=2 && ratio<0.10){
      showModal(`<div><b>CEO işten çıkarıldı.</b><div class="hr"></div><div class="mono">Sebep: 2+ yıl sonunda (Kümül. Temettü / Sermaye) < %10</div><div class="hr"></div><button class="btn" id="okFired">Tamam</button></div>`);
      $("okFired").onclick=()=>closeModal();
    }

    // Yıl satırı
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${state.year}</td><td>${ev.name}</td><td>${fmt(GWP)}</td>
      <td>${(lr_inc*100).toFixed(1)}%</td><td>${(lr_real*100).toFixed(1)}%</td><td>${(lr_star*100).toFixed(1)}%</td>
      <td>${fmt(paid)}</td><td>${fmt(outstanding)}</td><td>${fmt(chosenReserve)}</td><td>${fmt(finalReserve)}</td>
      <td>${fmt(comm)}</td><td>${fmt(adsCost)}</td>
      <td class="${preTax>=0?'ok':'bad'}">${fmt(preTax)}</td><td>${fmt(tax)}</td><td class="${afterTax>=0?'ok':'bad'}">${fmt(afterTax)}</td><td>${fmt(dividend)}</td>
      <td>${fmt(yearEndCap)}</td><td>${band(yearEndCap)}</td>`;
    tbody.prepend(tr);

    // Oyun bitiş koşulları
    if(fail){
      showModal(`<div><b>İflas tetiklendi.</b><div class="hr"></div><button class="btn" id="okFail">Tamam</button></div>`);
      $("okFail").onclick=()=>closeModal();
    }else if(state.year>=5){
      showModal(`<div><b>5 yıl tamamlandı.</b><div class="mono">Nihai oran: ${(ratio*100).toFixed(1)}% | Skor: ${state.score}</div><div class="hr"></div><button class="btn" id="okEnd">Tamam</button></div>`);
      $("okEnd").onclick=()=>closeModal();
    }

    state.year += 1;
    $("midInfo").innerText="";
    $("eventBadge").innerText="Olay: —";
    $("statusBox").innerText=`Yıl ${state.year-1} kapandı. Yeni yıl için "Yılı Başlat" → "Olayı Çek" adımları.`;
  }
}
</script>
</body>
</html>
