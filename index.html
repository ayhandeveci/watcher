<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Watcher â€” Bayes Rezerv Oyunu</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444}
  body{margin:0;background:#0f172a;color:var(--ink);font-family:Inter,system-ui}
  header{padding:12px;border-bottom:1px solid #1f2937}
  h1{font-size:18px;margin:0}
  .wrap{max-width:1280px;margin:auto;padding:14px;display:grid;gap:14px}
  .cols-4{display:grid;grid-template-columns:1.1fr 1fr 1fr 0.9fr;gap:14px}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:10px;padding:12px}
  h2{margin:0 0 8px;font-size:15px}
  select,.btn{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1023;color:#fff}
  .btn{cursor:pointer;margin-top:6px}
  .btn.primary{background:var(--accent);color:#000;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px 8px;text-align:left}
  th{position:sticky;top:0;background:#0e162a}
  .face{font-size:40px}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#111827;padding:16px;border-radius:12px;width:90%;max-width:600px}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choices .btn{flex:1}
  .spinner{width:28px;height:28px;border:3px solid #334155;border-top-color:#38bdf8;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header><h1>ğŸ•¹ï¸ Watcher â€” Bayes Rezerv Oyunu</h1></header>

<div class="wrap">
  <section class="cols-4">
    <!-- Panel 1 -->
    <div class="card">
      <h2>1) YÄ±l BaÅŸÄ± â€” PortfÃ¶y</h2>
      <label>Fiyatlama</label>
      <select id="price">
        <option value="cheap">Ucuz</option>
        <option value="mid" selected>Orta</option>
        <option value="exp">PahalÄ±</option>
      </select>
      <label>Underwriting</label>
      <select id="uw">
        <option value="loose">GevÅŸek</option>
        <option value="mid" selected>Orta</option>
        <option value="strict">SÄ±kÄ±</option>
      </select>
      <label>SatÄ±ÅŸ KanalÄ±</label>
      <select id="channel">
        <option value="agent">Acente</option>
        <option value="balanced" selected>Dengeli</option>
        <option value="digital">Dijital</option>
      </select>
      <label>PR / Reklam</label>
      <select id="ads">
        <option value="low">DÃ¼ÅŸÃ¼k</option>
        <option value="mid" selected>Orta</option>
        <option value="high">YÃ¼ksek</option>
      </select>

      <button class="btn primary" id="startYear">YÄ±lÄ± BaÅŸlat</button>
      <button class="btn" id="drawEvent" disabled>ğŸ² OlayÄ± Ã‡ek</button>
      <button class="btn" id="resetGame">SÄ±fÄ±rla</button>

      <div id="eventBadge" class="mono" style="margin-top:6px">Olay: â€”</div>
      <div id="midInfo" class="mono"></div>
    </div>

    <!-- Panel 2 -->
    <div class="card">
      <h2>2) YÄ±l OrtasÄ± â€” Rezerv</h2>
      <button class="btn" id="reserveBtn" disabled>ULR nasÄ±l geliÅŸir?</button>
      <div id="midPanel" class="mono" style="margin-top:8px"></div>
    </div>

    <!-- Panel 3 -->
    <div class="card">
      <h2>3) YÄ±l Sonu â€” TemettÃ¼</h2>
      <button class="btn" id="divBtn" disabled>TemettÃ¼ SeÃ§imi</button>
      <div id="endPanel" class="mono" style="margin-top:8px"></div>
    </div>

    <!-- Panel 4 -->
    <div class="card">
      <h2>4) CEO / Sermayedar</h2>
      <div id="ceoFace" class="face">ğŸ™‚</div>
      <div id="ceoStats" class="mono"></div>
      <div id="statusBox" class="mono" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- Alt tablo -->
  <section class="card">
    <h2>YÄ±l SonuÃ§larÄ±</h2>
    <table id="yearsTbl">
      <thead>
        <tr>
          <th>YÄ±l</th><th>Olay</th><th>GWP</th><th>incLR</th><th>realLR</th><th>LR*</th>
          <th>Ã–denen</th><th>Muallak</th><th>Rezerv</th><th>Kom.</th><th>PR</th>
          <th>VÃ–</th><th>Vergi</th><th>VS</th><th>TemettÃ¼</th><th>Sermaye</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- Modal -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
/* ---------- helpers ---------- */
const $=id=>document.getElementById(id);
const showModal=html=>{ $("modalBox").innerHTML=html; $("modal").style.display="flex"; };
const closeModal=()=>{ $("modal").style.display="none"; };
const fmt=(x,d=2)=>Number(x).toFixed(d);

function rngNormal(mu,sigma){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+sigma*z;}
function rngTNormal(mu,sigma,a,b){for(let i=0;i<2000;i++){const x=rngNormal(mu,sigma);if(x>=a&&x<=b)return x;}return Math.max(a,Math.min(b,mu));}

/* ---------- config ---------- */
const CONFIG={
  capital0:100, tax:0.20, baseGwp:90, lrBounds:[0.35,1.4], earnedShare:0.5,
  // GWP Ã§arpanlarÄ± (baÅŸlangÄ±Ã§ primi artÄ±k 90 sabit deÄŸil, seÃ§imlere gÃ¶re Ã¶lÃ§eklenir)
  fPrice:v=>v==="cheap"?1.30:v==="exp"?0.85:1.10,
  fUW:v=>v==="loose"?1.10:v==="strict"?0.90:1.00,
  fChannel:v=>v==="agent"?1.10:v==="digital"?0.95:1.00,
  fAds:l=>({low:0,mid:1,high:2}[l], 1 + 0.08*({low:0,mid:1,high:2}[l]) - 0.02*({low:0,mid:1,high:2}[l])**2),
  // Masraf oranlarÄ± parametreye baÄŸlÄ±
  commPct:ch=>ch==="agent"?0.18:ch==="digital"?0.05:0.12,
  adsPct:l=>l==="low"?0.01:l==="high"?0.06:0.03
};

/* ---------- state ---------- */
const state={
  year:1, capital:CONFIG.capital0, cumDiv:0, warned:false,
  cache:null, currentRow:null, fired:false, bankrupt:false
};

/* ---------- events (olasÄ±lÄ±klarÄ± DEÄÄ°ÅMEDÄ°: eÅŸit seÃ§iliyor) ---------- */
const EVENTS=[
 {key:"normal",name:"Normal",mu:0.65,sigma:0.05,paidShare:0.60,volMul:1.00,blurb:"Her ÅŸey normal."},
 {key:"pricewar",name:"Fiyat SavaÅŸÄ±",mu:0.74,sigma:0.06,paidShare:0.52,volMul:1.08,blurb:"Agresif fiyat rekabeti."},
 {key:"cat",name:"CAT",mu:0.80,sigma:0.08,paidShare:0.70,volMul:1.00,blurb:"Felaket yÄ±lÄ±, bÃ¼yÃ¼k hasar."},
 {key:"pr",name:"PR Krizi",mu:0.66,sigma:0.06,paidShare:0.58,volMul:0.95,blurb:"Ä°maj kaybÄ±, masraflar artar."}
];

/* ---------- portfolio risk score (realLR'ye eÄŸim verir) ---------- */
function portfolioRiskScore(price,uw,channel,ads){
  let s=0;
  if(price==="cheap")s+=0.6; else if(price==="exp")s-=0.4;
  if(uw==="loose")s+=0.8; else if(uw==="strict")s-=0.6;
  if(channel==="agent")s+=0.2; else if(channel==="digital")s-=0.1;
  if(ads==="high")s+=0.1; else if(ads==="low")s-=0.05;
  return Math.max(-1,Math.min(1,s/1.5));
}

/* ---------- table utils (SATIR ADIM ADIM GÃœNCELLER) ---------- */
function ensureRowForYear(y){
  const tb = document.querySelector("#yearsTbl tbody");
  let tr = tb.querySelector(`tr[data-year="${y}"]`);
  if(!tr){
    tr = document.createElement("tr");
    tr.dataset.year = y;
    tr.innerHTML = "<td>"+y+"</td>"+("<td>â€”</td>".repeat(15));
    tb.prepend(tr);
  }
  state.currentRow = tr;
  return tr;
}
function setCell(idx, html){
  if(!state.currentRow) return;
  const tds = state.currentRow.children;
  if(tds[idx]) tds[idx].innerHTML = html;
}

/* ---------- CEO panel ---------- */
function updateCEO(){
  const ratio=state.capital>0 ? state.cumDiv/state.capital : 0;
  $("ceoStats").innerText=`Sermaye=${fmt(state.capital)} | KÃ¼mÃ¼latif TemettÃ¼=${fmt(state.cumDiv)} | Oran=%${fmt(ratio*100)}`;
  if(state.capital<50){$("ceoFace").innerText="ğŸ’€";$("statusBox").innerText="Ä°flas!"; state.bankrupt=true; return;}
  if(ratio<0.1 && state.year>2){$("ceoFace").innerText="ğŸ˜¡";$("statusBox").innerText="CEO gÃ¶revden alÄ±ndÄ±!"; state.fired=true; return;}
  $("ceoFace").innerText= ratio>=0.2?"ğŸ˜ƒ":"ğŸ™‚";
  $("statusBox").innerText="Oyuna devam...";
}
updateCEO();

/* ---------- buttons ---------- */
$("resetGame").onclick=()=>{ location.reload(); };

$("startYear").onclick=()=>{
  if(state.bankrupt || state.fired) return; // oyun bitmiÅŸse engelle
  $("drawEvent").disabled=false;
  $("reserveBtn").disabled=true;
  $("divBtn").disabled=true;
  $("eventBadge").textContent="Olay: â€”";
  $("midInfo").textContent="";
  $("midPanel").textContent="";
  $("endPanel").textContent="";
  state.cache=null;
  ensureRowForYear(state.year);
  for(let i=1;i<=15;i++) setCell(i,"â€”"); // satÄ±rÄ± temizle
};

$("drawEvent").onclick=()=>{
  if(state.bankrupt || state.fired) return;
  // 5 saniye "zar atÄ±lÄ±yor" popup
  showModal(`<div><span class="spinner"></span> ğŸ² Zar atÄ±lÄ±yor...</div>`);
  setTimeout(()=>{
    closeModal();

    // olayÄ± seÃ§
    const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
    $("eventBadge").innerText=`Olay: ${ev.name} â€” ${ev.blurb}`;

    // GWP: seÃ§imlere gÃ¶re Ã¶lÃ§ekli (artÄ±k sabit 90 deÄŸil)
    const price=$("price").value, uw=$("uw").value, ch=$("channel").value, ads=$("ads").value;
    const gwpBase = CONFIG.baseGwp;
    const GWP = gwpBase
      * CONFIG.fPrice(price)
      * CONFIG.fUW(uw)
      * CONFIG.fChannel(ch)
      * CONFIG.fAds(ads)
      * ev.volMul;

    // incLR ve yÄ±l ortasÄ± bileÅŸenler
    const incLR=rngTNormal(ev.mu,ev.sigma,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);
    const earned=GWP*CONFIG.earnedShare;
    const incurred=earned*incLR;
    const paid=incurred*ev.paidShare;
    const outst=incurred-paid;

    // Komisyon ve PR giderleri (parametreye baÄŸlÄ±)
    const comm=GWP*CONFIG.commPct(ch);
    const pr=GWP*CONFIG.adsPct(ads);

    // cache
    state.cache={ev,GWP,incLR,paid,outst,comm,pr,mu_post:ev.mu,sigma_post:ev.sigma, price,uw,ch,ads};

    // Panel & tablo GÃœNCELLEME (adÄ±m adÄ±m)
    $("midInfo").innerText=`incLR=%${fmt(incLR*100)} | Ã–denen=${fmt(paid)} | Muallak=${fmt(outst)}`;
    $("reserveBtn").disabled=false;

    ensureRowForYear(state.year);
    setCell(1, ev.name);             // Olay
    setCell(2, fmt(GWP));            // GWP
    setCell(3, "%"+fmt(incLR*100));  // incLR
    setCell(6, fmt(paid));           // Ã–denen
    setCell(7, fmt(outst));          // Muallak
    setCell(9, fmt(comm));           // Komisyon
    setCell(10, fmt(pr));            // PR
  }, 5000);
};

$("reserveBtn").onclick=()=>{
  const k=state.cache; if(!k) return;
  showModal(`
    <h3>ULR nasÄ±l geliÅŸir?</h3>
    <div class="choices">
      <button class="btn" onclick="chooseReserve(0.60)">%60</button>
      <button class="btn" onclick="chooseReserve(0.75)">%75</button>
      <button class="btn" onclick="chooseReserve(0.90)">%90</button>
    </div>
  `);
};

window.chooseReserve=(lrStar)=>{
  closeModal();
  const k=state.cache; if(!k) return;
  const need=k.GWP*lrStar-(k.paid+k.outst);
  k.lrStar=lrStar;
  k.resv=Math.max(0,need);

  $("divBtn").disabled=false;
  $("midPanel").innerText=`SeÃ§ilen ULR hedefi=%${fmt(lrStar*100)}, Rezerv=${fmt(k.resv)}`;

  // tabloyu ADIM ADIM gÃ¼ncelle
  ensureRowForYear(state.year);
  setCell(5, "%"+fmt(lrStar*100)); // LR*
  setCell(8, fmt(k.resv));         // Rezerv
};

$("divBtn").onclick=()=>{
  const k=state.cache; if(!k) return;
  if(state.bankrupt || state.fired) return;

  // YIL SONU: realLR â€” portfÃ¶y riskine GÃ–RE EÄÄ°MLÄ° ve RASSAL
  const rScore=portfolioRiskScore(k.price,k.uw,k.ch,k.ads);
  // etkileri belirgin (Â±10 puan mean kaymasÄ±, sigma x2'ye kadar)
  const muAdj  = k.mu_post + 0.10 * rScore;
  const sigAdj = k.sigma_post * (1 + 1.0*Math.abs(rScore));

  const realLR=rngTNormal(muAdj,sigAdj,CONFIG.lrBounds[0],CONFIG.lrBounds[1]);
  k.realLR=realLR;

  // Rezerv gerÃ§ekleÅŸme farkÄ± (tam P&L etkili)
  const realNeed=k.GWP*realLR-(k.paid+k.outst);
  const delta=realNeed-k.resv;           // >0 gÃ¼Ã§lendirme, <0 serbest bÄ±rakma
  const pnlResv=delta;

  // KÃ¢r â€” zarar
  const VO=k.GWP-(k.paid+k.outst+k.resv)-k.comm-k.pr+pnlResv;
  const tax=VO>0 ? VO*CONFIG.tax : 0;
  const VS=VO-tax;

  // tabloya realLR ve P&L Ã¶n hesaplarÄ± yaz (temettÃ¼ sorulmadan Ã¶nce)
  ensureRowForYear(state.year);
  setCell(4, "%"+fmt(realLR*100)); // realLR
  setCell(11, (VO>=0?'<span class="ok">':'<span class="bad">')+fmt(VO)+'</span>'); // VÃ–
  setCell(12, fmt(tax));            // Vergi
  setCell(13, (VS>=0?'<span class="ok">':'<span class="bad">')+fmt(VS)+'</span>');  // VS

  // TemettÃ¼ modal
  showModal(`
    <h3>TemettÃ¼ SeÃ§</h3>
    <div class="choices">
      <button class="btn" onclick="payDiv(0)">%0</button>
      <button class="btn" onclick="payDiv(0.5)">%50</button>
      <button class="btn" onclick="payDiv(0.75)">%75</button>
      <button class="btn" onclick="payDiv(1)">%100</button>
    </div>
  `);

  // payDiv iÃ§inde tabloyu TAMAMLARIZ
  window.payDiv=(f)=>{
    closeModal();
    const div = VS>0 ? VS*f : 0;
    state.cumDiv += div;
    state.capital += VS - div;

    // tabloyu tamamla
    setCell(14, fmt(div));               // TemettÃ¼
    setCell(15, fmt(state.capital));     // Sermaye

    // CEO paneli hemen gÃ¼ncellensin
    updateCEO();

    // YÄ±lÄ± kapat
    $("drawEvent").disabled=true;
    $("reserveBtn").disabled=true;
    $("divBtn").disabled=true;

    // 5 YIL TAMAMLAMA KAZANÃ‡ KOÅULU
    if(!state.bankrupt && !state.fired && state.year>=5){
      const ratio = state.capital>0 ? state.cumDiv/state.capital : 0;
      showModal(`<h3>ğŸ‰ 5 yÄ±lÄ± tamamladÄ±n â€” Oyunu KazandÄ±n!</h3>
        <div class="mono">Sermaye: ${fmt(state.capital)} | KÃ¼mÃ¼latif TemettÃ¼: ${fmt(state.cumDiv)} | Oran: %${fmt(ratio*100)}</div>
        <div class="choices"><button class="btn" onclick="closeModal()">Tamam</button></div>`);
    }

    state.year++;
  };
};
</script>
</body>
</html>
